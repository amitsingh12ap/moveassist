<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MoveAssist">
<meta name="theme-color" content="#0f1729">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.svg">
<title>MoveAssist</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f6f7f8;
  --surface: #ffffff;
  --card: #ffffff;
  --card2: #f8fafc;
  --border: #e2e8f0;
  --accent: #2563eb;
  --accent2: #0ea5e9;
  --success: #22c55e;
  --error: #ef4444;
  --warn: #f59e0b;
  --text: #0f1729;
  --sub: #64748b;
  --dim: #94a3b8;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }
/* auth-mode: mobile only overrides */
@media (max-width: 899px) {
  body.auth-mode { overflow-y: auto !important; height: auto !important; }
  body.auth-mode #app { height: auto !important; min-height: 100dvh; }
  body.auth-mode #screens { overflow: visible !important; position: static !important; flex: none !important; }
  body.auth-mode #screen-auth { position: static !important; opacity: 1 !important; pointer-events: all !important; transform: none !important; padding: 0 !important; }
  body.auth-mode .bottom-nav { display: none !important; }
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-size: 15px;
  line-height: 1.5;
  overscroll-behavior: none;
}

/* APP SHELL */
#app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }

/* TOP BAR */
.topbar {
  padding: calc(var(--safe-top) + 10px) 20px 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255,255,255,0.97);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  z-index: 200;
  min-height: 60px;
}
.topbar-title {
  font-family: 'Inter', sans-serif;
  font-size: 18px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.3px;
}
.topbar-title span { color: var(--sub); font-weight: 700; }
.topbar-right { display: flex; align-items: center; gap: 10px; }
@media (min-width: 900px) {
  /* topbar hidden on desktop via JS (showApp sets it), and #app is flex row anyway */
  .topbar { display: none !important; }
}
.server-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--dim);
  transition: background 0.3s;
}
.server-dot.live { background: var(--success); box-shadow: 0 0 8px var(--success); animation: blink 2s infinite; }
.server-dot.dead { background: var(--error); }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
.avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff;
}

/* SCREENS */
#screens { flex: 1; overflow: hidden; position: relative; }
.screen {
  position: absolute; inset: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px 16px;
  opacity: 0; pointer-events: none;
  transform: translateY(12px);
  transition: opacity 0.2s, transform 0.2s;
}
.screen.active { opacity: 1; pointer-events: all; transform: translateY(0); }
.screen::-webkit-scrollbar { display: none; }

/* BOTTOM NAV */
.bottom-nav {
  display: flex;
  background: rgba(255,255,255,0.97);
  border-top: 1px solid var(--border);
  padding-bottom: var(--safe-bot);
  flex-shrink: 0;
}
.nav-btn {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  padding: 10px 0;
  background: none; border: none; cursor: pointer;
  color: var(--sub); font-family: inherit;
  transition: color 0.15s;
}
.nav-btn.active { color: var(--accent); }
.nav-icon { font-size: 22px; margin-bottom: 2px; }
.nav-label { font-size: 10px; font-weight: 600; letter-spacing: 0.3px; }

/* CARDS */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
}
.card-sm { padding: 12px 14px; border-radius: 12px; }

/* SECTION HEADER */
.section-head {
  font-family: 'Inter', sans-serif;
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 4px;
}
.section-sub { color: var(--sub); font-size: 13px; margin-bottom: 20px; }

/* FORM */
.field { margin-bottom: 14px; }
.field label { display: block; font-size: 12px; font-weight: 600; color: var(--sub); margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase; }
.field input, .field select, .field textarea {
  width: 100%;
  background: var(--card2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 12px 14px;
  border-radius: 10px;
  font-family: inherit;
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}
.field input:focus, .field select:focus, .field textarea:focus {
  border-color: var(--accent);
}
.field textarea { resize: none; height: 80px; }

/* BUTTONS */
.btn {
  width: 100%; padding: 14px;
  border-radius: 12px; border: none;
  font-family: 'Inter', sans-serif;
  font-weight: 700; font-size: 15px;
  cursor: pointer; transition: all 0.15s;
  letter-spacing: 0.3px;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:active { transform: scale(0.97); background: var(--accent); opacity:0.9; }
.btn-secondary { background: var(--card2); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:active { transform: scale(0.97); }
.btn-danger { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
.btn:disabled { opacity: 0.4; }

/* STATUS BADGES */
.badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 999px;
  font-size: 11px; font-weight: 600;
}
.badge-created { background: #f1f5f9; color: var(--sub); border: 1px solid var(--border); }
.badge-packed { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
.badge-loaded { background: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; }
.badge-in_transit { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; }
.badge-delivered { background: #d1fae5; color: #047857; border: 1px solid #a7f3d0; }
.badge-planning { background: #f1f5f9; color: var(--sub); border: 1px solid var(--border); }
.badge-in_progress { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; }
.badge-completed { background: #d1fae5; color: #047857; border: 1px solid #a7f3d0; }

/* MOVE CARD */
.move-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 16px; padding: 16px; margin-bottom: 12px;
  cursor: pointer; transition: border-color 0.15s, transform 0.15s;
  display: block; text-decoration: none;
}
.move-card:active { transform: scale(0.98); border-color: var(--accent); }
.move-card-title { font-weight: 700; font-size: 16px; margin-bottom: 6px; }
.move-card-meta { font-size: 12px; color: var(--sub); display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px; }
.move-card-route { display: flex; align-items: center; gap: 8px; font-size: 13px; margin: 6px 0; }
.move-card-route .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
.move-card-route .line { width: 20px; height: 1px; background: var(--border); flex-shrink: 0; }

/* BOX ITEM */
.box-item {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 12px; padding: 14px; margin-bottom: 10px;
  display: flex; align-items: center; gap: 12px;
}
.box-icon { width: 40px; height: 40px; flex-shrink: 0; background: var(--card2); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--accent); }
.box-info { flex: 1; min-width: 0; }
.box-label { font-weight: 600; font-size: 15px; }
.box-meta { font-size: 12px; color: var(--sub); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* FURNITURE ITEM */
.furniture-item {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 12px; padding: 14px; margin-bottom: 10px;
  display: flex; align-items: center; gap: 12px;
}

/* QR DISPLAY */
.qr-container {
  background: white; border-radius: 16px;
  padding: 20px; display: flex; flex-direction: column;
  align-items: center; gap: 10px; margin: 16px 0;
}
.qr-container img { width: 200px; height: 200px; display: block; }

/* TOAST */
#toast {
  position: fixed; bottom: calc(70px + var(--safe-bot) + 12px);
  left: 16px; right: 16px;
  background: var(--text); border: 1px solid var(--border);
  color: #fff; padding: 12px 16px; border-radius: 12px;
  font-size: 14px; font-weight: 500;
  transform: translateY(20px); opacity: 0;
  transition: all 0.25s; z-index: 1000;
  text-align: center;
}
#toast.show { transform: translateY(0); opacity: 1; }
#toast.success { background: #059669; border-color: #059669; color: #fff; }
#toast.error { background: #dc2626; border-color: #dc2626; color: #fff; }

/* LOADING SPINNER */
.spinner {
  width: 20px; height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  display: inline-block;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* MODAL */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(15,23,41,0.55);
  backdrop-filter: blur(4px);
  z-index: 100;
  display: flex; align-items: flex-end;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal-sheet {
  width: 100%;
  background: var(--surface);
  border-radius: 24px 24px 0 0;
  border-top: 1px solid var(--border);
  padding: 0 20px calc(var(--safe-bot) + 20px);
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
}
.modal-overlay.open .modal-sheet { transform: translateY(0); }
.modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 20px; }
.modal-title { font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 800; margin-bottom: 20px; }

/* EMPTY STATE */
.empty {
  text-align: center; padding: 48px 20px;
  color: var(--dim);
}
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty-title { font-size: 16px; font-weight: 600; color: var(--sub); margin-bottom: 6px; }
.empty-sub { font-size: 13px; }

/* STAT GRID */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.stat-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 14px; padding: 18px;
  transition: box-shadow 0.15s, transform 0.1s;
}
.stat-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); transform: translateY(-1px); }
.stat-val { font-family: 'Inter', sans-serif; font-size: 30px; font-weight: 800; color: var(--accent); line-height: 1; margin: 6px 0 4px; }
.stat-label { font-size: 12px; color: var(--sub); font-weight: 500; letter-spacing: 0.2px; }
.stat-icon { font-size: 22px; margin-bottom: 4px; display: block; }

/* PAYMENT GATE BANNER */
.payment-gate {
  background: #fffbeb;
  border: 1px solid #fde68a;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  text-align: center;
}
.payment-gate .gate-icon { font-size: 40px; margin-bottom: 10px; }
.payment-gate .gate-title { font-family: 'Inter', sans-serif; font-size: 17px; font-weight: 800; color: #b45309; margin-bottom: 6px; }
.payment-gate .gate-sub { font-size: 13px; color: var(--sub); margin-bottom: 16px; line-height: 1.6; }

/* INVOICE */
.invoice-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
.invoice-row:last-child { border-bottom: none; }
.invoice-row.total { font-weight: 700; font-size: 16px; color: var(--accent); }
.invoice-row.total span:last-child { font-family: 'Inter', sans-serif; }

/* PAYMENT METHOD SELECTOR */
.pay-method-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.pay-method-btn {
  background: var(--card2); border: 2px solid var(--border);
  border-radius: 12px; padding: 14px 10px;
  text-align: center; cursor: pointer; transition: all 0.15s;
  font-family: inherit;
}
.pay-method-btn:active { transform: scale(0.97); }
.pay-method-btn.sel { border-color: var(--accent); background: rgba(240,192,64,0.08); }
.pay-method-icon { font-size: 24px; margin-bottom: 6px; }
.pay-method-label { font-size: 12px; font-weight: 600; color: var(--sub); }
.pay-method-btn.sel .pay-method-label { color: var(--accent); }

/* STATUS TIMELINE */
.timeline { position: relative; padding-left: 20px; }
.timeline::before { content: ''; position: absolute; left: 7px; top: 0; bottom: 0; width: 2px; background: var(--border); }
.timeline-item { position: relative; padding: 0 0 20px 20px; }
.timeline-item:last-child { padding-bottom: 0; }
.timeline-dot {
  position: absolute; left: -13px; top: 2px;
  width: 14px; height: 14px; border-radius: 50%;
  background: var(--border); border: 2px solid var(--bg);
}
.timeline-dot.done { background: var(--success); }
.timeline-dot.current { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: pulse 2s infinite; }
.timeline-label { font-size: 13px; font-weight: 600; }
.timeline-sub { font-size: 11px; color: var(--dim); margin-top: 2px; }

/* PAYMENT MODAL */
.upi-input { font-size: 18px; text-align: center; letter-spacing: 1px; }

/* LOCK WARNING */
.lock-warn { background: #1a0a00; border: 1px solid var(--warn); border-radius: 10px; padding: 10px 14px; font-size: 12px; color: var(--warn); margin-top: 12px; }

/* DIVIDER */
.divider { height: 1px; background: var(--border); margin: 16px 0; }

/* ADMIN TABS */
.admin-tab.active { background: #ffffff !important; color: var(--text) !important; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }

/* ADMIN STAT ROW */
.admin-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.admin-stat {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 14px; padding: 14px;
}
.admin-stat-val { font-family: 'Inter', sans-serif; font-size: 26px; font-weight: 800; }
.admin-stat-label { font-size: 11px; color: var(--sub); margin-top: 2px; }

/* USER ROW */
.user-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--border);
}
.user-row:last-child { border-bottom: none; }
.user-role-pill {
  font-size: 10px; font-weight: 700; padding: 3px 8px;
  border-radius: 999px; letter-spacing: 0.5px;
}

/* PAYMENT ROW */
.payment-row {
  padding: 12px 0; border-bottom: 1px solid var(--border);
}
.payment-row:last-child { border-bottom: none; }

/* SECTION TITLE */
.admin-section-title {
  font-size: 11px; font-weight: 700; color: var(--sub);
  letter-spacing: 0.8px; margin-bottom: 12px; text-transform: uppercase;
}

.scan-area {
  width: 100%; aspect-ratio: 1;
  border-radius: 20px; overflow: hidden;
  position: relative; background: #0f1729;
  margin: 16px 0;
}
.scan-area video { width: 100%; height: 100%; object-fit: cover; }
.scan-overlay {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
}
.scan-frame {
  width: 220px; height: 220px;
  border: 2px solid var(--accent);
  border-radius: 20px;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
  position: relative;
  transition: border-color 0.3s;
}
.scan-frame.detected {
  border-color: var(--success);
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.55), 0 0 20px var(--success);
}
/* Corner accents */
.scan-frame::before, .scan-frame::after {
  content: '';
  position: absolute;
  width: 24px; height: 24px;
  border-color: var(--accent);
  border-style: solid;
}
.scan-frame::before { top: -2px; left: -2px; border-width: 3px 0 0 3px; border-radius: 4px 0 0 0; }
.scan-frame::after  { bottom: -2px; right: -2px; border-width: 0 3px 3px 0; border-radius: 0 0 4px 0; }
/* Scan line */
@keyframes scanline {
  0%   { top: 10%; opacity: 1; }
  90%  { top: 85%; opacity: 1; }
  100% { top: 85%; opacity: 0; }
}
.scan-line {
  position: absolute;
  left: 8px; right: 8px;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  border-radius: 1px;
  animation: scanline 2s ease-in-out infinite;
  box-shadow: 0 0 8px var(--accent);
}

/* CHIP ROW */
.chip-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
.chip {
  padding: 6px 12px; border-radius: 999px;
  background: var(--card2); border: 1px solid var(--border);
  font-size: 12px; font-weight: 500; cursor: pointer;
  transition: all 0.15s; color: var(--sub);
}
.chip.sel { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 700; }

/* SCAN LOG */
.scan-log-item {
  display: flex; gap: 12px; align-items: flex-start;
  padding: 10px 0; border-bottom: 1px solid var(--border);
}
.scan-log-item:last-child { border-bottom: none; }
.scan-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); margin-top: 6px; flex-shrink: 0; }
.scan-log-status { font-size: 12px; font-weight: 700; color: var(--success); }
.scan-log-time { font-size: 11px; color: var(--dim); }
.scan-log-note { font-size: 13px; color: var(--sub); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESPONSIVE DESKTOP LAYOUT ‚Äî ‚â• 900px
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Desktop Sidebar */
.desk-sidebar {
  display: none;  /* shown only by body.logged-in at >=900px */
  width: 256px;
  background: #0f1729;
  flex-direction: column;
  border-right: none;
  box-shadow: none;
  flex-shrink: 0;
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  padding: 0;
}
.desk-sidebar-brand {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 20px 20px 18px;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  margin-bottom: 8px;
}
.desk-sidebar-icon {
  width: 36px; height: 36px; border-radius: 10px;
  background: #2563eb;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
.desk-sidebar-title { font-weight: 800; font-size: 15px; color: #ffffff; }
.desk-sidebar-sub { font-size: 10px; color: #64748b; margin-top: 1px; letter-spacing: 0.5px; text-transform: uppercase; }
.desk-nav-section { font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: #475569; padding: 12px 20px 6px; }
.desk-nav-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 11px 20px;
  background: none;
  border: none;
  border-left: 3px solid transparent;
  color: #94a3b8;
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
}
.desk-nav-btn:hover { background: rgba(255,255,255,0.06); color: #e2e8f0; }
.desk-nav-btn.active { background: rgba(37,99,235,0.2); border-left-color: #2563eb; color: #fff; font-weight: 600; }
.desk-nav-icon { width: 18px; height: 18px; flex-shrink: 0; opacity: 0.8; }
.desk-nav-btn.active .desk-nav-icon { opacity: 1; }
.desk-sidebar-footer {
  margin-top: auto;
  padding: 16px 20px;
  border-top: 1px solid rgba(255,255,255,0.07);
}
.desk-logout-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  background: none;
  border: none;
  color: #ef4444;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 0;
  opacity: 0.8;
  transition: opacity 0.15s;
}
.desk-logout-btn:hover { opacity: 1; }

/* ‚îÄ‚îÄ APP BODY: flex column on all sizes ‚îÄ‚îÄ */
.app-body {
  display: flex;
  flex: 1;
  flex-direction: column;
  min-height: 0;
  overflow: hidden;
}

@media (min-width: 900px) {
  /* ‚ïê‚ïê‚ïê APP SHELL ‚ïê‚ïê‚ïê */
  html, body { overflow: hidden; height: 100vh; height: 100dvh; }

  #app {
    display: flex;
    flex-direction: row;        /* sidebar | right-col */
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
  }

  /* Mobile topbar hidden on desktop */
  .topbar { display: none !important; }
  .bottom-nav { display: none !important; }

  /* Sidebar + desk-topbar: shown when logged in (CSS-only, no inline JS) */
  body.logged-in .desk-sidebar { display: flex !important; }
  body.logged-in .desk-topbar { display: flex !important; }
  body.auth-mode .desk-topbar { display: none !important; }
  body.auth-mode .desk-sidebar { display: none !important; }

  /* Right column: desk-topbar + screens */
  .app-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 0;
    height: 100vh;
    height: 100dvh;
  }

  /* Desktop inner topbar */
  /* .desk-topbar visibility controlled by JS */

  /* Screens area */
  #screens {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--bg);
    min-height: 0;
  }

  /* Each screen fills #screens absolutely, scrolls internally */
  .screen {
    position: absolute;
    top: 60px; left: 0; right: 0; bottom: 0;
    opacity: 0;
    pointer-events: none;
    transform: none !important;
    transition: opacity 0.18s ease !important;
    display: block !important;   /* always in DOM, opacity controls visibility */
    padding: 32px 40px;
    overflow-y: auto;
    overflow-x: hidden;
  }
  .screen.active {
    opacity: 1;
    pointer-events: all;
  }

  /* Auth screen: no topbar offset, centered */
  #screen-auth {
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
  }

  /* Section headings */
  .section-head { font-size: 26px; }

  /* Grids */
  #movesList { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
  #movesList .move-card { margin-bottom: 0; }
  #movesList > .empty { grid-column: 1/-1; }
  #boxesList { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 14px; }
  #boxesList .box-item { margin-bottom: 0; }
  #furnitureList { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 14px; }
  #furnitureList .furniture-item { margin-bottom: 0; }
  #agentMovesList { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
  #agentMovesList .agent-move-card { margin-bottom: 0; }

  /* Stat grids */
  .stat-grid { grid-template-columns: repeat(4, 1fr); }
  #agentStatGrid { grid-template-columns: repeat(3, 1fr) !important; }
  .stat-card { padding: 20px; }
  .stat-val { font-size: 32px; }
  .pay-method-grid { grid-template-columns: repeat(4, 1fr); }

  /* Move detail 2-col */
  .move-detail-layout { flex-direction: row; align-items: flex-start; }
  .move-detail-main { flex: 1; min-width: 0; }
  .move-detail-sidebar { width: 280px; flex-shrink: 0; }

  /* Scan: max-width */
  #screen-scan { max-width: 600px; margin-left: auto; margin-right: auto; }

  /* Modals: center dialog */
  .modal-overlay {
    align-items: center;
    justify-content: center;
    padding: 40px;
    background: rgba(15,23,41,0.6);
  }
  .modal-sheet {
    border-radius: 16px;
    max-width: 520px;
    width: 100%;
    max-height: 90vh;
    transform: scale(0.96) !important;
    transition: transform 0.25s cubic-bezier(0.32,0.72,0,1) !important;
  }
  .modal-overlay.open .modal-sheet { transform: scale(1) !important; }
  .modal-handle { display: none; }

  /* Toast: top-right */
  #toast {
    bottom: auto !important;
    top: 76px;
    left: auto;
    right: 24px;
    width: 320px;
    border-radius: 10px !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  }
}

@media (min-width: 1200px) {
  .screen { padding: 40px 48px; max-width: 1400px; }
  #movesList { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
  #agentMovesList { grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); }
}

/* ‚îÄ‚îÄ‚îÄ DESKTOP STATS BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.desktop-stats-banner {
  display: none;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 28px;
}
@media (min-width: 900px) {
  .desktop-stats-banner { display: grid; }
}
.kpi-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px 20px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  transition: box-shadow 0.15s, transform 0.1s;
}
.kpi-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); transform: translateY(-1px); }
.kpi-icon {
  width: 38px; height: 38px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  margin-bottom: 4px;
}
.kpi-val { font-size: 30px; font-weight: 800; line-height: 1; color: var(--text); }
.kpi-label { font-size: 12px; color: var(--sub); font-weight: 500; }
.kpi-trend { font-size: 11px; font-weight: 600; }

/* ‚îÄ‚îÄ‚îÄ AGENT STAT CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#agentStatGrid .stat-card { padding: 18px 20px; }
#agentStatGrid .stat-icon { font-size: 22px; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; background: #eff6ff; }

/* ‚îÄ‚îÄ‚îÄ DESKTOP SECTION DIVIDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.desk-section-title {
  font-size: 13px; font-weight: 700; color: var(--sub);
  letter-spacing: 0.5px; text-transform: uppercase;
  margin-bottom: 14px;
  display: none;
}
@media (min-width: 900px) { .desk-section-title { display: block; } }

/* ‚îÄ‚îÄ‚îÄ SCREEN HEADER (title + action btn row) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.screen-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 24px;
  gap: 12px;
}
.screen-header-left { flex: 1; min-width: 0; }
.screen-header .section-head { margin-bottom: 2px; }
.screen-header .section-sub { margin-bottom: 0; }
.screen-header-action {
  flex-shrink: 0;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 10px 18px;
  font-family: inherit;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  transition: background 0.15s, transform 0.1s;
}
.screen-header-action:hover { background: #1d4ed8; }
.screen-header-action:active { transform: scale(0.97); }

/* ‚îÄ‚îÄ‚îÄ IMPROVED MOVE CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.move-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-left: 4px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: border-color 0.15s, box-shadow 0.15s, transform 0.1s;
  display: block;
  text-decoration: none;
}
.move-card:hover { border-left-color: var(--accent); box-shadow: 0 4px 20px rgba(37,99,235,0.12); transform: translateY(-2px); }
.move-card.status-active { border-left-color: var(--success); }
.move-card.status-pending { border-left-color: var(--warn); }
.move-card.status-completed { border-left-color: #6366f1; }

/* ‚îÄ‚îÄ‚îÄ MOVE CARD CONTENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.move-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 10px; }
.move-card-title { font-weight: 700; font-size: 15px; line-height: 1.3; flex: 1; min-width: 0; }
.move-card-badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 99px; white-space: nowrap; flex-shrink: 0; }
.move-card-route { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--sub); margin-bottom: 10px; }
.move-card-route .from, .move-card-route .to { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.move-card-route .arrow { color: var(--dim); flex-shrink: 0; font-size: 14px; }
.move-card-footer { display: flex; justify-content: space-between; align-items: center; }
.move-card-stats { display: flex; gap: 12px; }
.move-card-stat { font-size: 11px; color: var(--sub); display: flex; align-items: center; gap: 3px; }
.move-card-date { font-size: 11px; color: var(--dim); }

/* ‚îÄ‚îÄ‚îÄ STATUS BADGE COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.status-badge-payment_pending { background: #fef3c7; color: #b45309; }
.status-badge-active { background: #dcfce7; color: #15803d; }
.status-badge-in_progress { background: #dbeafe; color: #1d4ed8; }
.status-badge-completed { background: #ede9fe; color: #6d28d9; }
.status-badge-closed { background: #f1f5f9; color: #64748b; }

/* ‚îÄ‚îÄ‚îÄ BACK BUTTON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: none;
  border: none;
  color: var(--sub);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  padding: 0;
  margin-bottom: 20px;
  font-family: inherit;
  transition: color 0.15s;
}
.back-btn:hover { color: var(--accent); }

/* ‚îÄ‚îÄ‚îÄ MOVE DETAIL 2-COL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.move-detail-layout { display: flex; flex-direction: column; gap: 20px; }
@media (min-width: 900px) {
  .move-detail-layout { flex-direction: row; align-items: flex-start; }
  .move-detail-main { flex: 1; min-width: 0; }
  .move-detail-sidebar { width: 280px; flex-shrink: 0; }
}

/* ‚îÄ‚îÄ‚îÄ DETAIL CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.detail-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}
.detail-card-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--sub); margin-bottom: 12px; }
.detail-action-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 12px 14px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  margin-bottom: 8px;
  text-align: left;
  transition: all 0.15s;
}
.detail-action-btn:hover { background: #eff6ff; border-color: var(--accent); color: var(--accent); }
.detail-action-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.detail-action-btn .icon { font-size: 18px; flex-shrink: 0; }
.detail-action-btn .label { flex: 1; }
.detail-action-btn .count { font-size: 11px; color: var(--dim); background: var(--bg); padding: 2px 6px; border-radius: 99px; }

/* ‚îÄ‚îÄ‚îÄ AGENT CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.agent-move-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: box-shadow 0.15s, transform 0.1s;
}
.agent-move-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); transform: translateY(-1px); }
.agent-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.agent-card-customer { font-weight: 700; font-size: 14px; }
.agent-card-phone { font-size: 12px; color: var(--sub); margin-top: 2px; }
.agent-card-boxes { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--sub); margin-top: 10px; }
.agent-card-progress { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.agent-card-progress-fill { height: 100%; background: var(--success); border-radius: 3px; transition: width 0.3s; }

/* ‚îÄ‚îÄ‚îÄ DESKTOP AUTH LAYOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.auth-desktop-wrap {
  display: flex;
  width: 100%;
  max-width: 860px;
  margin: 0 auto;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(15,23,41,0.12);
  flex-shrink: 0;
}
.auth-hero {
  display: none;
  width: 340px;
  flex-shrink: 0;
  background: linear-gradient(160deg, #1e40af 0%, #0f1729 100%);
  padding: 40px 32px;
  flex-direction: column;
  justify-content: center;
  color: #fff;
}
.auth-hero-logo { font-size: 36px; margin-bottom: 20px; }
.auth-hero-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
.auth-hero-sub { font-size: 13px; color: #94a3b8; line-height: 1.7; margin-bottom: 32px; }
.auth-hero-feature { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #cbd5e1; margin-bottom: 12px; }
.auth-hero-feature-icon { width: 28px; height: 28px; border-radius: 8px; background: rgba(37,99,235,0.2); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.auth-form-panel { flex: 1; background: var(--card); padding: 36px 32px; }
@media (min-width: 900px) {
  .auth-hero { display: flex; }
  .auth-form-panel { padding: 40px 36px; }
}

/* ‚îÄ‚îÄ‚îÄ STAT CARDS IMPROVED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
}
.stat-val { font-size: 26px; font-weight: 800; color: var(--accent); line-height: 1; margin-bottom: 4px; }
.stat-label { font-size: 11px; color: var(--sub); font-weight: 500; }
.stat-icon { font-size: 20px; margin-bottom: 6px; }

/* ‚îÄ‚îÄ‚îÄ PROFILE SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.profile-header-card {
  background: var(--accent);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  color: #fff;
}
.profile-avatar-lg {
  width: 60px; height: 60px; border-radius: 50%;
  background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; font-weight: 700; color: #fff;
  flex-shrink: 0;
}
.profile-name { font-size: 18px; font-weight: 700; margin-bottom: 3px; }
.profile-email { font-size: 13px; color: rgba(255,255,255,0.75); margin-bottom: 4px; }
.profile-role-chip { display: inline-block; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; background: rgba(255,255,255,0.2); color: #fff; padding: 3px 8px; border-radius: 99px; }

/* ‚îÄ‚îÄ‚îÄ MOBILE ONLY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
@media (max-width: 899px) {
  .auth-desktop-wrap { border-radius: 0; box-shadow: none; }
  .auth-form-panel { padding: 16px 16px 40px; background: transparent; }
  .screen { padding: 16px; }
  .auth-desktop-header { display: none; }
  .desk-sidebar { display: none !important; }
  .desk-topbar { display: none !important; }
}
@media (min-width: 900px) {
  .auth-mobile-header { display: none; }
}


/* ‚îÄ‚îÄ‚îÄ DESKTOP INNER TOPBAR (matches admin header) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.desk-topbar {
  background: #ffffff;
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  height: 60px;
  display: none; /* shown by CSS: body.logged-in at >=900px */
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  z-index: 100;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.desk-topbar-breadcrumb {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.2px;
}
.desk-topbar-right {
  display: flex;
  align-items: center;
  gap: 14px;
}
@media (max-width: 899px) {
  .desk-topbar { display: none !important; }
}
</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-title" id="topbarTitle">Move<span>Assist</span></div>
    <div class="topbar-right">
      <div id="topbarBreadcrumb" style="display:none;font-size:13px;color:var(--sub);margin-right:12px"></div>
      <div class="server-dot" id="serverDot" title="Server status"></div>
      <!-- Notification Bell -->
      <div id="notifBell" style="position:relative;cursor:pointer;display:none" onclick="openNotifications()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--sub)" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <span id="notifBadge" style="display:none;position:absolute;top:-4px;right:-4px;background:#ef4444;color:#fff;font-size:10px;font-weight:700;min-width:16px;height:16px;border-radius:99px;display:flex;align-items:center;justify-content:center;padding:0 3px"></span>
      </div>
      <div id="topbarUserInfo" style="display:none;margin-right:4px;text-align:right">
        <div style="font-size:13px;font-weight:600" id="topbarUserName"></div>
        <div style="font-size:11px;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px" id="topbarUserRole"></div>
      </div>
      <div class="avatar" id="userAvatar">?</div>
    </div>
  </div>

  <nav class="desk-sidebar" id="deskSidebar">
    <div class="desk-sidebar-brand">
      <div class="desk-sidebar-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="m16 8 4 4-4 4"/><line x1="20" y1="12" x2="8" y2="12"/></svg>
      </div>
      <div>
        <div class="desk-sidebar-title">MoveAssist</div>
        <div class="desk-sidebar-sub" id="deskSidebarRole">CUSTOMER PORTAL</div>
      </div>
    </div>
    <div class="desk-nav-section">NAVIGATION</div>
    <button class="desk-nav-btn active" id="dsk-home" onclick="navTo('home')">
      <svg class="desk-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      My Moves
    </button>
    <button class="desk-nav-btn" id="dsk-scan" onclick="navTo('scan')">
      <svg class="desk-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      QR Scanner
    </button>
    <button class="desk-nav-btn" id="dsk-profile" onclick="navTo('profile')">
      <svg class="desk-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
      Profile
    </button>
    <div class="desk-sidebar-footer">
      <button class="desk-logout-btn" onclick="doLogout()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </button>
    </div>
  </nav>

  <!-- RIGHT COLUMN: topbar + screens -->
  <div class="app-body">
    <!-- Desktop topbar (inside right column) -->
    <div class="desk-topbar" id="deskTopbar" style="display:none">
      <div class="desk-topbar-breadcrumb" id="deskBreadcrumb">Dashboard</div>
      <div class="desk-topbar-right">
        <div class="server-dot" id="serverDot2"></div>
        <div style="text-align:right;line-height:1.3">
          <div id="deskUserName" style="font-size:13px;font-weight:600;color:var(--text)"></div>
          <div id="deskUserRole" style="font-size:10px;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px"></div>
        </div>
        <div class="avatar" id="deskAvatar" style="width:36px;height:36px;font-size:13px;cursor:default">?</div>
      </div>
    </div>
    <!-- SCREENS -->
    <div id="screens">

    <!-- AUTH SCREEN -->
    <div class="screen active" id="screen-auth">
      <div class="auth-desktop-wrap">
        <!-- Hero panel (desktop only) -->
        <div class="auth-hero">
          <div class="auth-hero-logo">üì¶</div>
          <div class="auth-hero-title">MoveAssist</div>
          <div class="auth-hero-sub">Your complete home shifting companion. Track every box, document every item, generate reports.</div>
          <div class="auth-hero-feature"><div class="auth-hero-feature-icon">üì¶</div>QR code tracking for every box</div>
          <div class="auth-hero-feature"><div class="auth-hero-feature-icon">üì∑</div>Scan to update box status</div>
          <div class="auth-hero-feature"><div class="auth-hero-feature-icon">üõãÔ∏è</div>Document furniture condition</div>
          <div class="auth-hero-feature"><div class="auth-hero-feature-icon">üìÑ</div>Auto-generate PDF reports</div>
        </div>
        <!-- Form panel -->
        <div class="auth-form-panel">
          <!-- Mobile header (hidden on desktop) -->
          <div style="text-align:center;margin-bottom:28px;padding-top:32px" class="auth-mobile-header">
            <div style="font-size:48px;margin-bottom:10px">üì¶</div>
            <div class="section-head">MoveAssist</div>
            <div class="section-sub">Home shifting, made structured</div>
          </div>
          <!-- Desktop header (hidden on mobile) -->
          <div style="margin-bottom:28px" class="auth-desktop-header">
            <div style="font-size:22px;font-weight:800;color:var(--text);margin-bottom:4px">Welcome back</div>
            <div style="font-size:13px;color:var(--sub)">Sign in to your MoveAssist account</div>
          </div>
          <!-- Tab switcher -->
          <div style="display:flex;gap:0;margin-bottom:24px;background:var(--bg);border-radius:10px;padding:3px;border:1px solid var(--border)">
            <button class="btn btn-primary" id="authTabLogin" onclick="switchAuthTab('login')" style="flex:1;border-radius:8px;padding:10px;font-size:13px">Sign In</button>
            <button class="btn btn-secondary" id="authTabRegister" onclick="switchAuthTab('register')" style="flex:1;border-radius:8px;padding:10px;font-size:13px;background:transparent;border:none;color:var(--sub)">Register</button>
          </div>
          <div id="authLoginForm">
            <div class="field"><label>Email Address</label><input type="email" id="loginEmail" placeholder="you@email.com" autocomplete="email"/></div>
            <div class="field"><label>Password</label><input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
            <button class="btn btn-primary" onclick="doLogin()" id="loginBtn" style="margin-top:4px">Sign In ‚Üí</button>
          </div>
          <div id="authRegisterForm" style="display:none">
            <div class="field"><label>Full Name</label><input type="text" id="regName" placeholder="Amit Sharma"/></div>
            <div class="field"><label>Email Address</label><input type="email" id="regEmail" placeholder="you@email.com" autocomplete="email"/></div>
            <div class="field"><label>Password</label><input type="password" id="regPassword" placeholder="Min 8 characters" autocomplete="new-password"/></div>
            <div class="field"><label>Phone (optional)</label><input type="tel" id="regPhone" placeholder="+91-9999999999"/></div>
            <button class="btn btn-primary" onclick="doRegister()" id="registerBtn">Create Account ‚Üí</button>
          </div>
          <div style="text-align:center;font-size:11px;color:var(--dim);margin-top:20px">
            Server: <span id="authServerUrl" style="color:var(--sub)">localhost:3000</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PAYMENT SCREEN -->
    <div class="screen" id="screen-payment">
      <button onclick="showScreen('home');loadMoves()" style="background:none;border:none;color:var(--sub);font-size:14px;cursor:pointer;margin-bottom:16px;padding:0;display:flex;align-items:center;gap:6px">‚Üê Back</button>
      <div id="paymentContent"></div>
    </div>

    <!-- AGENT DASHBOARD SCREEN -->
    <div class="screen" id="screen-agent">
      <div class="screen-header">
        <div class="screen-header-left">
          <div class="section-head">Agent Dashboard</div>
          <div class="section-sub" id="agentSubtitle">Assigned moves</div>
        </div>
      </div>
      <div id="agentStatGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px"></div>
      <div id="agentMovesList"></div>
    </div>

    <!-- ADMIN DASHBOARD SCREEN -->
    <div class="screen" id="screen-admin">
      <!-- Admin Tab Bar -->
      <div style="display:flex;gap:4px;margin-bottom:24px;background:#f1f5f9;padding:4px;border-radius:10px;border:1px solid var(--border)">
        <button class="admin-tab active" id="atab-overview" onclick="switchAdminTab('overview')" style="flex:1;padding:9px 12px;border:none;border-radius:7px;background:transparent;color:var(--sub);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">Overview</button>
        <button class="admin-tab" id="atab-moves" onclick="switchAdminTab('moves')" style="flex:1;padding:9px 12px;border:none;border-radius:7px;background:transparent;color:var(--sub);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">Moves</button>
        <button class="admin-tab" id="atab-payments" onclick="switchAdminTab('payments')" style="flex:1;padding:9px 12px;border:none;border-radius:7px;background:transparent;color:var(--sub);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">Payments</button>
        <button class="admin-tab" id="atab-users" onclick="switchAdminTab('users')" style="flex:1;padding:9px 12px;border:none;border-radius:7px;background:transparent;color:var(--sub);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">Users</button>
        <button class="admin-tab" id="atab-flags" onclick="switchAdminTab('flags')" style="flex:1;padding:9px 12px;border:none;border-radius:7px;background:transparent;color:var(--sub);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">‚öë Flags</button>
      </div>
      <div id="adminContent"><div style="text-align:center;padding:40px"><div class="spinner"></div></div></div>
    </div>

    <!-- HOME / MOVES SCREEN -->
    <div class="screen" id="screen-home">
      <div class="screen-header">
        <div class="screen-header-left">
          <div class="section-head">My Moves</div>
          <div class="section-sub">All your home shifting projects</div>
        </div>
        <button class="screen-header-action" onclick="openCreateMove()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><path d="M12 5v14M5 12h14"/></svg>
          New Move
        </button>
      </div>
      <!-- Desktop KPI row (populated by loadMoves) -->
      <div class="desktop-stats-banner" id="homeStatsBanner" style="display:none"></div>
      <div class="desk-section-title" id="homeSectionTitle" style="display:none">YOUR MOVES</div>
      <div id="movesList"><div class="empty"><div class="empty-icon">üè†</div><div class="empty-title">No moves yet</div><div class="empty-sub">Click + New Move to get started</div></div></div>
    </div>

    <!-- MOVE DETAIL SCREEN -->
    <div class="screen" id="screen-move">
      <button onclick="goBack()" class="back-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><path d="m15 18-6-6 6-6"/></svg>
        Back to Moves
      </button>
      <div id="moveDetailContent"></div>
    </div>

    <!-- BOXES SCREEN -->
    <div class="screen" id="screen-boxes">
      <button onclick="openMove(currentMove.id)" class="back-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><path d="m15 18-6-6 6-6"/></svg> Move Detail</button>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div><div class="section-head" style="margin-bottom:0">Boxes</div><div style="font-size:12px;color:var(--sub)" id="boxesMoveTitle"></div></div>
        <button class="btn btn-primary" onclick="openAddBox()" style="width:auto;padding:10px 16px;font-size:13px">+ Box</button>
      </div>
      <!-- Bulk action bar (shown when boxes selected) -->
      <div id="bulkBar" style="display:none;background:var(--accent);border-radius:12px;padding:12px 16px;margin-bottom:14px;display:none;align-items:center;gap:10px;flex-wrap:wrap">
        <span id="bulkCount" style="color:#fff;font-size:13px;font-weight:700;flex:1">0 selected</span>
        <button onclick="selectAllBoxes()" style="background:rgba(255,255,255,0.2);border:none;border-radius:8px;color:#fff;padding:7px 12px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer">Select All</button>
        <button onclick="clearSelection()" style="background:rgba(255,255,255,0.2);border:none;border-radius:8px;color:#fff;padding:7px 12px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer">Clear</button>
        <button onclick="openBulkUpdate()" style="background:#fff;border:none;border-radius:8px;color:var(--accent);padding:7px 14px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer">‚ö° Bulk Update</button>
      </div>
      <div id="boxesList"></div>
    </div>

    <!-- BOX DETAIL SCREEN -->
    <div class="screen" id="screen-box-detail">
      <button onclick="showScreen('boxes')" style="background:none;border:none;color:var(--sub);font-size:14px;cursor:pointer;margin-bottom:16px;padding:0">‚Üê Boxes</button>
      <div id="boxDetailContent"></div>
    </div>

    <!-- SCAN SCREEN -->
    <div class="screen" id="screen-scan">
      <div class="section-head">Scan QR</div>
      <div class="section-sub" id="scanSubtitle">Point camera at a box QR code</div>

      <!-- Camera permission prompt -->
      <div id="cameraPrompt" style="text-align:center;padding:32px 16px">
        <div style="font-size:64px;margin-bottom:16px">üì∑</div>
        <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:8px">Camera Access</div>
        <div style="color:var(--sub);font-size:14px;line-height:1.6;margin-bottom:28px">MoveAssist needs your camera to scan box QR codes. Your camera is only used while scanning.</div>
        <button class="btn btn-primary" id="cameraPermBtn" onclick="requestCameraPermission()" style="max-width:280px;margin:0 auto">Allow Camera Access</button>
        <div style="margin-top:16px">
          <button onclick="skipToManual()" style="background:none;border:none;color:var(--sub);font-family:inherit;font-size:13px;cursor:pointer;text-decoration:underline">Skip ‚Äî enter QR manually</button>
        </div>
      </div>

      <!-- Camera viewfinder -->
      <div class="scan-area" id="scanArea" style="display:none">
        <video id="scanVideo" playsinline autoplay muted></video>
        <canvas id="scanCanvas" style="display:none"></canvas>
        <div class="scan-overlay">
          <div class="scan-frame" id="scanFrame"><div class="scan-line"></div></div>
        </div>
        <!-- Scanning pulse indicator -->
        <div id="scanStatus" style="position:absolute;bottom:12px;left:0;right:0;text-align:center;font-size:12px;color:rgba(255,255,255,0.7);font-family:'Inter',sans-serif">
          Scanning...
        </div>
      </div>

      <!-- Camera permission error -->
      <div id="cameraError" style="display:none">
        <div class="card" style="text-align:center;padding:24px;border-color:var(--error)">
          <div style="font-size:32px;margin-bottom:10px">üìµ</div>
          <div style="font-weight:600;margin-bottom:6px;color:var(--error)">Camera Access Denied</div>
          <div style="font-size:13px;color:var(--sub);margin-bottom:16px">Allow camera permission in your browser settings, then reload the page.</div>
          <button class="btn btn-secondary" onclick="retryCamera()">Try Again</button>
        </div>
      </div>

      <!-- Scan result panel -->
      <div id="scanResult" style="display:none;margin-top:16px">
        <div class="card" id="scannedBoxCard"></div>
        <div style="margin-top:12px">
          <div style="font-size:13px;font-weight:600;color:var(--sub);margin-bottom:8px;letter-spacing:0.5px">UPDATE STATUS TO</div>
          <div class="chip-row" id="statusChips"></div>
          <div class="field"><label>Location</label><input type="text" id="scanLocation" placeholder="e.g. Living Room, Truck Bay 2"/></div>
          <div class="field"><label>Notes</label><input type="text" id="scanNotes" placeholder="Optional notes"/></div>
          <!-- Photo proof upload -->
          <div class="field">
            <label style="display:flex;align-items:center;gap:6px">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              Photo Proof (optional)
            </label>
            <div id="photoPreview" style="display:none;margin-bottom:8px;position:relative">
              <img id="photoPreviewImg" style="width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid var(--border)"/>
              <button onclick="clearPhoto()" style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);border:none;border-radius:50%;width:24px;height:24px;color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">‚úï</button>
            </div>
            <label style="display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;background:var(--card2);border:1px dashed var(--border);border-radius:10px;cursor:pointer;font-size:13px;color:var(--sub)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
              Take photo or upload
              <input type="file" id="scanPhoto" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoSelect(this)"/>
            </label>
          </div>
          <div style="display:flex;gap:10px">
            <button class="btn btn-secondary" onclick="resetScanner()" style="flex:1">Scan Again</button>
            <button class="btn btn-primary" onclick="submitScan()" id="scanSubmitBtn" style="flex:2">Log Scan</button>
          </div>
        </div>
      </div>

      <!-- Manual fallback -->
      <div id="scanPlaceholder" style="margin-top:12px;display:none">
        <div class="card" style="padding:16px">
          <div style="font-size:12px;font-weight:600;color:var(--sub);margin-bottom:10px;letter-spacing:0.5px">MANUAL LOOKUP</div>
          <div style="display:flex;gap:8px">
            <input type="text" id="manualQR" placeholder="Paste QR code / UUID" style="flex:1;background:var(--card2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;font-family:inherit;font-size:14px;outline:none"/>
            <button class="btn btn-secondary" onclick="lookupManualQR()" style="width:auto;padding:10px 16px;white-space:nowrap">Lookup</button>
          </div>
        </div>
      </div>
    </div>

    <!-- FURNITURE SCREEN -->
    <div class="screen" id="screen-furniture">
      <button onclick="openMove(currentMove.id)" style="background:none;border:none;color:var(--sub);font-size:14px;cursor:pointer;margin-bottom:16px;padding:0">‚Üê Back</button>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div><div class="section-head" style="margin-bottom:0">Furniture</div><div style="font-size:12px;color:var(--sub)" id="furnMoveTitle"></div></div>
        <button class="btn btn-primary" id="addFurnBtn2" onclick="openAddFurniture()" style="width:auto;padding:10px 16px;font-size:13px">+ Item</button>
      </div>
      <div id="furnitureList"></div>
    </div>

    <!-- REPORT SCREEN -->
    <div class="screen" id="screen-report">
      <div class="section-head">Move Report</div>
      <div class="section-sub">Generate your move summary PDF</div>
      <div id="reportContent">
        <div class="empty"><div class="empty-icon">üìÑ</div><div class="empty-title">Select a move first</div><div class="empty-sub">Go to a move and tap Generate Report</div></div>
      </div>
    </div>

    <!-- PROFILE SCREEN -->
    <div class="screen" id="screen-profile"><div class="profile-inner">
      <div class="section-head" style="margin-bottom:4px">Profile</div>
      <div class="section-sub">Account & settings</div>
      <div class="profile-header-card">
        <div class="profile-avatar-lg" id="profileAvatar">?</div>
        <div>
          <div class="profile-name" id="profileName">‚Äî</div>
          <div class="profile-email" id="profileEmail">‚Äî</div>
          <span class="profile-role-chip" id="profileRoleBadge">CUSTOMER</span>
        </div>
      </div>
      <div class="card card-sm" style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:11px;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Server</div>
          <div style="font-size:14px;font-weight:500" id="profileServer">‚Äî</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:11px;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Status</div>
          <div style="font-size:14px;font-weight:600" id="profileServerStatus">‚Äî</div>
        </div>
      </div>
      <button class="btn btn-danger" onclick="doLogout()" style="margin-top:8px">Sign Out</button>
    </div>

  </div><!-- /screens -->

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav" id="bottomNav" style="display:none">
    <button class="nav-btn active" id="nav-home" onclick="navTo('home')">
      <span class="nav-icon">üè†</span><span class="nav-label">Moves</span>
    </button>
    <button class="nav-btn" id="nav-scan" onclick="navTo('scan')">
      <span class="nav-icon">üì∑</span><span class="nav-label">Scan</span>
    </button>
    <button class="nav-btn" id="nav-profile" onclick="navTo('profile')">
      <span class="nav-icon">üë§</span><span class="nav-label">Profile</span>
    </button>
  </nav>

  </div><!-- /app-body -->
</div><!-- /app -->

<!-- MODAL: Payment -->
<div class="modal-overlay" id="payModal" onclick="closeModal('payModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title" id="payModalTitle">Complete Payment</div>
    <div id="payModalContent"></div>
  </div>
</div>

<!-- MODAL: Cash Payment (Agent) -->
<div class="modal-overlay" id="cashModal" onclick="closeModal('cashModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Cash / Offline Payment</div>
    <div class="field"><label>Amount Received (‚Çπ)</label><input type="number" id="cashAmount" placeholder="0.00" inputmode="decimal"/></div>
    <div class="field"><label>Payment Mode</label>
      <select id="cashMode">
        <option value="cash">Cash</option>
        <option value="upi_offline">UPI (shown to agent)</option>
        <option value="cheque">Cheque</option>
        <option value="bank_transfer">Bank Transfer</option>
      </select>
    </div>
    <div class="field"><label>Notes</label><input type="text" id="cashNotes" placeholder="Reference number, remarks‚Ä¶"/></div>
    <div class="lock-warn">‚è± Once submitted, this entry is locked after 10 minutes and cannot be edited.</div>
    <button class="btn btn-primary" onclick="submitCashPayment()" id="cashSubmitBtn" style="margin-top:16px">Mark Payment Received</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- MODAL: Create Move -->
<div class="modal-overlay" id="createMoveModal" onclick="closeModal('createMoveModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:90vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div class="modal-title">New Move Project</div>

    <!-- Step 1: Addresses -->
    <div id="createStep1">
      <div class="field">
        <label>Move Title</label>
        <input type="text" id="newMoveTitle" placeholder="e.g. Home Shifting ‚Äî Sector 82"/>
      </div>
      <div class="field" style="position:relative">
        <label style="display:flex;justify-content:space-between;align-items:center">
          üìç Pickup Address <span style="color:#94a3b8;font-size:11px">(start typing for suggestions)</span>
          <button type="button" onclick="useMyLocation()" id="gpsBtn" style="background:#eff6ff;border:1px solid #bfdbfe;color:#2563eb;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;white-space:nowrap">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/><circle cx="12" cy="12" r="8" stroke-dasharray="2 2"/></svg>
            Use my location
          </button>
        </label>
        <input type="text" id="newMoveFrom" placeholder="Current address" autocomplete="off"
               oninput="addressAutocomplete(this,'fromSuggestions','from')"/>
        <div id="fromSuggestions" class="address-suggestions"></div>
      </div>
      <div class="field" style="position:relative">
        <label>üè† Delivery Address</label>
        <input type="text" id="newMoveTo" placeholder="Destination address" autocomplete="off"
               oninput="addressAutocomplete(this,'toSuggestions','to')"/>
        <div id="toSuggestions" class="address-suggestions"></div>
      </div>
      <div id="intraCityWarning" style="display:none;background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;font-size:13px;color:#dc2626;margin-bottom:12px">
        ‚ö†Ô∏è We currently only support moves within the same city.
      </div>
      <div class="field">
        <label>Move Date</label>
        <input type="date" id="newMoveDate"/>
      </div>
      <button class="btn btn-primary" onclick="createMoveStep2()" id="createMoveNextBtn">Next ‚Äî Add Details ‚Üí</button>
    </div>

    <!-- Step 2: Property + Estimator -->
    <div id="createStep2" style="display:none">
      <div style="font-size:13px;font-weight:700;color:var(--sub);margin-bottom:14px;text-transform:uppercase;letter-spacing:0.5px">Property Details</div>
      <div class="field">
        <label>Home Size</label>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px" id="bhkGrid">
          <button onclick="selectBHK('studio')" id="bhk-studio" class="chip-btn" style="padding:10px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:12px;font-weight:600;background:#fff;cursor:pointer">STUDIO</button>
          <button onclick="selectBHK('1bhk')" id="bhk-1bhk" class="chip-btn" style="padding:10px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:12px;font-weight:600;background:#fff;cursor:pointer">1BHK</button>
          <button onclick="selectBHK('2bhk')" id="bhk-2bhk" class="chip-btn" style="padding:10px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:12px;font-weight:600;background:#fff;cursor:pointer">2BHK</button>
          <button onclick="selectBHK('3bhk')" id="bhk-3bhk" class="chip-btn" style="padding:10px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:12px;font-weight:600;background:#fff;cursor:pointer">3BHK</button>
          <button onclick="selectBHK('4bhk')" id="bhk-4bhk" class="chip-btn" style="padding:10px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:12px;font-weight:600;background:#fff;cursor:pointer">4BHK</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="field">
          <label>Pickup Floor</label>
          <input type="number" id="floorFrom" placeholder="0 = Ground" min="0" max="50" value="0" oninput="updateEstimate()"/>
        </div>
        <div class="field">
          <label>Delivery Floor</label>
          <input type="number" id="floorTo" placeholder="0 = Ground" min="0" max="50" value="0" oninput="updateEstimate()"/>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="liftFrom" onchange="updateEstimate()"/> Lift at pickup
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="liftTo" onchange="updateEstimate()"/> Lift at delivery
        </label>
      </div>
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-bottom:16px">
        <input type="checkbox" id="hasFragile" onchange="updateEstimate()"/> I have fragile/valuable items
      </label>

      <!-- Cost Estimate Card -->
      <div id="estimateCard" style="background:linear-gradient(135deg,#eff6ff,#f5f3ff);border:1px solid #dbeafe;border-radius:14px;padding:16px;margin-bottom:16px;display:none">
        <div style="font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Estimated Cost</div>
        <div id="estimateTotal" style="font-size:28px;font-weight:800;color:#2563eb;margin-bottom:8px"></div>
        <div id="estimateBreakdown" style="font-size:12px;color:#64748b"></div>
        <div style="font-size:10px;color:#94a3b8;margin-top:8px">*Estimate only. Final price confirmed after agent assessment.</div>
      </div>

      <div style="display:flex;gap:10px">
        <button class="btn btn-secondary" onclick="document.getElementById('createStep1').style.display='';document.getElementById('createStep2').style.display='none'" style="flex:1">‚Üê Back</button>
        <button class="btn btn-primary" onclick="createMove()" id="createMoveBtn" style="flex:2">Create Move üéâ</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Add Box -->
<!-- MODAL: Add Box -->
<div class="modal-overlay" id="addBoxModal" onclick="closeModal('addBoxModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Add Box</div>
    <div class="field"><label>Label</label><input type="text" id="newBoxLabel" placeholder="e.g. Kitchen Essentials"/></div>
    <div class="field"><label>Category</label>
      <select id="newBoxCategory">
        <option value="general">General</option>
        <option value="kitchen">Kitchen</option>
        <option value="bedroom">Bedroom</option>
        <option value="electronics">Electronics</option>
        <option value="fragile">Fragile</option>
        <option value="clothes">Clothes</option>
        <option value="books">Books</option>
        <option value="bathroom">Bathroom</option>
      </select>
    </div>
    <div class="field"><label>Contents</label><textarea id="newBoxContents" placeholder="What's inside this box?"></textarea></div>
    <button class="btn btn-primary" onclick="addBox()" id="addBoxBtn">Add Box + Generate QR</button>
  </div>
</div>

<!-- MODAL: Bulk Update -->
<div class="modal-overlay" id="bulkUpdateModal" onclick="closeModal('bulkUpdateModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">‚ö° Bulk Update</div>
    <div style="font-size:13px;color:var(--sub);margin-bottom:16px" id="bulkModalSubtitle">Updating 0 boxes</div>
    <div style="font-size:12px;font-weight:600;color:var(--sub);margin-bottom:8px;letter-spacing:0.5px">SET STATUS TO</div>
    <div class="chip-row" id="bulkStatusChips" style="margin-bottom:16px"></div>
    <div class="field"><label>Location</label><input type="text" id="bulkLocation" placeholder="e.g. Living Room, Truck"/></div>
    <div class="field"><label>Notes</label><input type="text" id="bulkNotes" placeholder="Optional notes for all boxes"/></div>
    <div class="field">
      <label style="display:flex;align-items:center;gap:6px">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        Photo Proof (optional)
      </label>
      <div id="bulkPhotoPreview" style="display:none;margin-bottom:8px;position:relative">
        <img id="bulkPhotoPreviewImg" style="width:100%;max-height:160px;object-fit:cover;border-radius:10px;border:1px solid var(--border)"/>
        <button onclick="clearBulkPhoto()" style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);border:none;border-radius:50%;width:24px;height:24px;color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">‚úï</button>
      </div>
      <label style="display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;background:var(--card2);border:1px dashed var(--border);border-radius:10px;cursor:pointer;font-size:13px;color:var(--sub)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Take photo or upload
        <input type="file" id="bulkPhoto" accept="image/*" capture="environment" style="display:none" onchange="handleBulkPhotoSelect(this)"/>
      </label>
    </div>
    <button class="btn btn-primary" onclick="submitBulkUpdate()" id="bulkSubmitBtn">Update Boxes</button>
  </div>
</div>

<!-- MODAL: Add Furniture -->
<!-- MODAL: Add Furniture -->
<div class="modal-overlay" id="addFurnModal" onclick="closeModal('addFurnModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Add Furniture ‚Äî Pickup</div>    <div class="field"><label>Item Name</label><input type="text" id="newFurnName" placeholder="e.g. 3-Seater Sofa"/></div>
    <div class="field"><label>Category</label>
      <select id="newFurnCategory">
        <option value="sofa">Sofa / Couch</option>
        <option value="bed">Bed</option>
        <option value="table">Table</option>
        <option value="chair">Chair</option>
        <option value="wardrobe">Wardrobe</option>
        <option value="appliance">Appliance</option>
        <option value="tv">TV / Electronics</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="field"><label>Condition at Pickup</label>
      <select id="newFurnCondition">
        <option value="excellent">Excellent</option>
        <option value="good" selected>Good</option>
        <option value="fair">Fair</option>
        <option value="poor">Poor</option>
      </select>
    </div>
    <div class="field"><label>Pre-existing Damage Notes</label><textarea id="newFurnDamage" placeholder="Any damage before pickup? (optional)"></textarea></div>
    <div class="field">
      <label style="display:flex;align-items:center;gap:6px">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Pickup Photo Proof
      </label>
      <div id="addFurnPhotoPreview" style="display:none;margin-bottom:8px;position:relative">
        <img id="addFurnPhotoImg" style="width:100%;max-height:160px;object-fit:cover;border-radius:10px;border:1px solid var(--border)"/>
        <button onclick="clearFurnPhoto('addFurn')" style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);border:none;border-radius:50%;width:24px;height:24px;color:#fff;cursor:pointer;font-size:13px">‚úï</button>
      </div>
      <label style="display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;background:var(--card2);border:1px dashed var(--border);border-radius:10px;cursor:pointer;font-size:13px;color:var(--sub)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Take photo or upload
        <input type="file" id="addFurnPhotoInput" accept="image/*" capture="environment" style="display:none" onchange="handleFurnPhoto('addFurn',this)"/>
      </label>
    </div>
    <button class="btn btn-primary" onclick="addFurniture()" id="addFurnBtn">Add Item</button>
  </div>
</div>

<!-- MODAL: Furniture Delivery -->
<div class="modal-overlay" id="deliverFurnModal" onclick="closeModal('deliverFurnModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Mark as Delivered</div>
    <input type="hidden" id="deliverFurnId"/>
    <div style="font-size:13px;color:var(--sub);margin-bottom:16px" id="deliverFurnName"></div>
    <div class="field"><label>Condition at Delivery</label>
      <select id="deliverFurnCondition">
        <option value="excellent">Excellent ‚Äî no change</option>
        <option value="good" selected>Good</option>
        <option value="fair">Fair</option>
        <option value="poor">Poor ‚Äî damaged</option>
      </select>
    </div>
    <div class="field"><label>Delivery Notes</label><textarea id="deliverFurnNotes" placeholder="Any new damage or notes?"></textarea></div>
    <div class="field">
      <label style="display:flex;align-items:center;gap:6px">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Delivery Photo Proof <span style="color:var(--error);margin-left:2px">*</span>
      </label>
      <div id="deliverFurnPhotoPreview" style="display:none;margin-bottom:8px;position:relative">
        <img id="deliverFurnPhotoImg" style="width:100%;max-height:160px;object-fit:cover;border-radius:10px;border:1px solid var(--border)"/>
        <button onclick="clearFurnPhoto('deliverFurn')" style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);border:none;border-radius:50%;width:24px;height:24px;color:#fff;cursor:pointer;font-size:13px">‚úï</button>
      </div>
      <label style="display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;background:var(--card2);border:1px dashed var(--border);border-radius:10px;cursor:pointer;font-size:13px;color:var(--sub)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Take photo or upload
        <input type="file" id="deliverFurnPhotoInput" accept="image/*" capture="environment" style="display:none" onchange="handleFurnPhoto('deliverFurn',this)"/>
      </label>
    </div>
    <button class="btn btn-primary" onclick="submitFurnDelivery()" id="deliverFurnBtn">Confirm Delivery</button>
  </div>
</div>

<!-- MODAL: Complete Move Checklist -->
<div class="modal-overlay" id="completeMoveModal" onclick="closeModal('completeMoveModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Complete Move</div>
    <div id="completeMoveChecklist" style="margin-bottom:18px"></div>
    <div id="completeMoveActions"></div>
  </div>
</div>
<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BASE = window.location.origin;
let token = localStorage.getItem('ma_token') || '';
let user = JSON.parse(localStorage.getItem('ma_user') || 'null');
let currentMove = null;
let currentBox = null;
let currentScreen = 'auth';

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (token) opts.headers['Authorization'] = 'Bearer ' + token;
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(BASE + path, opts);
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data.error || `Error ${r.status}`);
  return data;
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  }
  if (token && user) {
    showApp();
  }
  checkServer();
  setInterval(checkServer, 5000);
});

async function checkServer() {
  const dot = document.getElementById('serverDot');
  const dot2 = document.getElementById('serverDot2');
  const pss = document.getElementById('profileServerStatus');
  try {
    const r = await fetch(BASE + '/health');
    if (r.ok) {
      dot.className = 'server-dot live';
      if (dot2) dot2.className = 'server-dot live';
      if (pss) { pss.textContent = 'üü¢ Online'; pss.style.color = 'var(--success)'; }
    } else throw new Error();
  } catch {
    dot.className = 'server-dot dead';
    if (dot2) dot2.className = 'server-dot dead';
    if (pss) { pss.textContent = 'üî¥ Offline'; pss.style.color = 'var(--error)'; }
  }
}

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchAuthTab(tab) {
  const isLogin = tab === 'login';
  document.getElementById('authLoginForm').style.display = isLogin ? 'block' : 'none';
  document.getElementById('authRegisterForm').style.display = isLogin ? 'none' : 'block';
  document.getElementById('authTabLogin').className = isLogin ? 'btn btn-primary' : 'btn btn-secondary';
  document.getElementById('authTabRegister').className = isLogin ? 'btn btn-secondary' : 'btn btn-primary';
  if (!isLogin) {
    document.getElementById('authTabLogin').style.cssText = 'flex:1;border-radius:8px;padding:10px;background:transparent;border:none;color:var(--sub)';
    document.getElementById('authTabRegister').style.cssText = 'flex:1;border-radius:8px;padding:10px';
  } else {
    document.getElementById('authTabLogin').style.cssText = 'flex:1;border-radius:8px;padding:10px';
    document.getElementById('authTabRegister').style.cssText = 'flex:1;border-radius:8px;padding:10px;background:transparent;border:none;color:var(--sub)';
  }
}

async function doLogin() {
  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'Logging in...';
  try {
    const data = await api('POST', '/api/auth/login', {
      email: document.getElementById('loginEmail').value,
      password: document.getElementById('loginPassword').value,
    });
    token = data.token;
    user = data.user;
    localStorage.setItem('ma_token', token);
    localStorage.setItem('ma_user', JSON.stringify(user));
    showApp();
    toast('Welcome back, ' + user.name.split(' ')[0] + '!', 'success');
  } catch(e) {
    toast(e.message, 'error');
  }
  btn.disabled = false; btn.textContent = 'Login';
}

async function doRegister() {
  const btn = document.getElementById('registerBtn');
  btn.disabled = true; btn.textContent = 'Creating...';
  try {
    const data = await api('POST', '/api/auth/register', {
      name: document.getElementById('regName').value,
      email: document.getElementById('regEmail').value,
      password: document.getElementById('regPassword').value,
      phone: document.getElementById('regPhone').value,
    });
    token = data.token;
    user = data.user;
    localStorage.setItem('ma_token', token);
    localStorage.setItem('ma_user', JSON.stringify(user));
    showApp();
    toast('Account created! Welcome üéâ', 'success');
  } catch(e) {
    toast(e.message, 'error');
  }
  btn.disabled = false; btn.textContent = 'Create Account';
}

function doLogout() {
  token = ''; user = null;
  localStorage.removeItem('ma_token');
  localStorage.removeItem('ma_user');
  document.getElementById('bottomNav').style.display = 'none';
  document.getElementById('topbarUserInfo').style.display = 'none';
  document.body.classList.remove('logged-in');
  document.body.classList.add('auth-mode');
  showScreen('auth');
}

function isDesktop() { return window.innerWidth >= 900; }

function showApp() {
  document.body.classList.add('logged-in');
  document.body.classList.remove('auth-mode');
  // Bottom nav (mobile only)
  document.getElementById('bottomNav').style.display = 'flex';

  const initials = user?.name?.split(' ').map(w => w[0]).join('').substring(0, 2) || '?';
  document.getElementById('userAvatar').textContent = initials;
  document.getElementById('profileAvatar').textContent = initials;
  document.getElementById('profileName').textContent = user?.name || '‚Äî';
  document.getElementById('profileEmail').textContent = user?.email || '‚Äî';
  document.getElementById('profileServer').textContent = BASE;

  // Role badge on profile
  const roleBadgeColor = { agent: 'var(--accent2)', admin: '#a78bfa', customer: 'var(--success)' };
  const roleEl = document.getElementById('profileRoleBadge');
  if (roleEl) {
    roleEl.textContent = (user?.role || 'customer').toUpperCase();
    roleEl.style.color = roleBadgeColor[user?.role] || 'var(--sub)';
  }

  // Desktop sidebar role label
  const roleLabel = { admin: 'SAAS CONTROL CENTER', agent: 'AGENT PORTAL', customer: 'CUSTOMER PORTAL' };
  document.getElementById('deskSidebarRole').textContent = roleLabel[user?.role] || 'CUSTOMER PORTAL';

  // Populate desktop inner topbar
  document.getElementById('deskUserName').textContent = user?.name || '';
  document.getElementById('deskUserRole').textContent = (user?.role || '').toUpperCase();
  document.getElementById('deskAvatar').textContent = initials;

  // Sync server dot to desktop topbar
  const dot1 = document.getElementById('serverDot');
  const dot2 = document.getElementById('serverDot2');
  if (dot1 && dot2) { dot2.className = dot1.className; dot2.style.cssText = dot1.style.cssText; }

  // Update sidebar home button label based on role
  const homeBtn = document.getElementById('dsk-home');
  const homeBtnLabel = homeBtn?.querySelector('span') || homeBtn?.lastChild;
  if (homeBtn) {
    const svgPart = homeBtn.innerHTML.match(/<svg[^]*?<\/svg>/)?.[0] || '';
    if (user?.role === 'admin') homeBtn.innerHTML = svgPart + ' Admin Panel';
    else if (user?.role === 'agent') homeBtn.innerHTML = svgPart + ' Dashboard';
    else homeBtn.innerHTML = svgPart + ' My Moves';
  }

  // Hide QR Scanner from sidebar for admin (field tool only)
  // Also hide for customers ‚Äî they can't scan boxes
  const scanBtn = document.getElementById('dsk-scan');
  const mobileScanBtn = document.getElementById('nav-scan');
  const isCustomer = user?.role === 'customer' || (!user?.role);
  if (scanBtn) scanBtn.style.display = (user?.role === 'admin' || isCustomer) ? 'none' : '';
  if (mobileScanBtn) mobileScanBtn.style.display = isCustomer ? 'none' : '';

  // Topbar user info (mobile only)
  document.getElementById('topbarUserInfo').style.display = isDesktop() ? 'none' : 'flex';
  document.getElementById('topbarUserInfo').style.flexDirection = 'column';
  document.getElementById('topbarUserInfo').style.alignItems = 'flex-end';
  const uname = document.getElementById('topbarUserName');
  const urole = document.getElementById('topbarUserRole');
  if (uname) uname.textContent = user?.name || '';
  if (urole) urole.textContent = (user?.role || '').toUpperCase();

  // Mobile nav labels
  const mobileHome = document.getElementById('nav-home');
  if (mobileHome) {
    if (user?.role === 'admin') { mobileHome.querySelector('.nav-label').textContent = 'Admin'; mobileHome.querySelector('.nav-icon').textContent = 'üõ°Ô∏è'; }
    else if (user?.role === 'agent') { mobileHome.querySelector('.nav-label').textContent = 'Dashboard'; mobileHome.querySelector('.nav-icon').textContent = 'üóÇÔ∏è'; }
    else { mobileHome.querySelector('.nav-label').textContent = 'Moves'; mobileHome.querySelector('.nav-icon').textContent = 'üè†'; }
  }

  if (user?.role === 'admin') { showScreen('admin'); openAdminDashboard(); }
  else if (user?.role === 'agent') { navTo('agent'); loadAgentMoves(); }
  else { navTo('home'); loadMoves(); }
  loadNotifCount();
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function navTo(screen) {
  // Mobile bottom nav
  ['home','scan','profile'].forEach(s => {
    document.getElementById('nav-'+s)?.classList.remove('active');
  });
  document.getElementById('nav-'+screen)?.classList.add('active');

  // Desktop sidebar
  ['home','scan','profile'].forEach(s => {
    document.getElementById('dsk-'+s)?.classList.remove('active');
  });
  document.getElementById('dsk-'+screen)?.classList.add('active');

  if (screen === 'scan') startCamera();
  else stopCamera();
  const screenId = screen === 'home' && user?.role === 'admin' ? 'admin' : screen === 'home' && user?.role === 'agent' ? 'agent' : screen;
  showScreen(screenId);
  if (screenId === 'admin') openAdminDashboard();
  else if (screenId === 'agent') loadAgentMoves();
  setTopbar(screen);

  // Scroll handled by showScreen
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('screen-' + id);
  if (el) {
    el.classList.add('active');
    // Scroll to top within the screen
    setTimeout(() => { el.scrollTop = 0; }, 50);
  }
  if (id === 'auth') {
    document.body.classList.add('auth-mode');
    // Auth: hide desk-topbar, show sidebar brand only
    const dt = document.getElementById('deskTopbar');
    if (dt) dt.style.display = 'none';
  } else {
    document.body.classList.remove('auth-mode');
    // Re-show desk-topbar if desktop + logged in
    if (isDesktop() && user) {
      const dt = document.getElementById('deskTopbar');
      if (dt) dt.style.display = 'flex';
    }
  }
  currentScreen = id;
}

function goBack() {
  if (user?.role === 'agent' || user?.role === 'admin') {
    showScreen('agent');
    loadAgentMoves();
  } else {
    showScreen('home');
    loadMoves();
  }
}

function setTopbar(screen) {
  const mTitles = {
    home: 'Move<span style="color:var(--sub);font-weight:700">Assist</span>',
    agent: 'Agent Dashboard',
    scan: 'QR Scanner',
    profile: 'Profile',
    move: 'Move Detail',
    boxes: 'Boxes',
    furniture: 'Furniture',
    report: 'Report',
    payment: 'Payment',
    admin: 'Admin',
  };
  const dTitles = {
    home: 'My Moves',
    agent: 'Agent Dashboard',
    scan: 'QR Scanner',
    profile: 'Profile',
    move: 'Move Detail',
    boxes: 'Boxes',
    furniture: 'Furniture',
    report: 'Report',
    payment: 'Payment',
    admin: 'Admin Dashboard',
  };
  const mobileTitle = document.getElementById('topbarTitle');
  if (mobileTitle) mobileTitle.innerHTML = mTitles[screen] || 'MoveAssist';
  // Update desk breadcrumb
  const bread = document.getElementById('deskBreadcrumb');
  if (bread) bread.textContent = dTitles[screen] || 'Dashboard';
  // Sync server dot on desktop topbar
  const dot2 = document.getElementById('serverDot2');
  if (dot2) {
    const dot1 = document.getElementById('serverDot');
    if (dot1) dot2.className = dot1.className;
    if (dot1) dot2.style.cssText = dot1.style.cssText;
  }
}

// ‚îÄ‚îÄ‚îÄ AGENT DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAgentMoves() {
  const list = document.getElementById('agentMovesList');
  const subtitle = document.getElementById('agentSubtitle');
  const statGrid = document.getElementById('agentStatGrid');
  list.innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
  try {
    const moves = await api('GET', '/api/moves/agent/assigned');
    subtitle.textContent = `${moves.length} move${moves.length !== 1 ? 's' : ''} assigned to you`;

    // Stats
    const active = moves.filter(m => m.status === 'active').length;
    const inProg = moves.filter(m => m.status === 'in_progress').length;
    const done = moves.filter(m => m.status === 'completed').length;
    if (statGrid) statGrid.innerHTML = `
      <div class="stat-card">
        <div class="stat-icon" style="background:#eff6ff;color:var(--accent)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
        <div class="stat-val">${moves.length}</div>
        <div class="stat-label">Total Assigned</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:#fef3c7;color:#b45309"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="m16 8 4 4-4 4"/><line x1="20" y1="12" x2="8" y2="12"/></svg></div>
        <div class="stat-val" style="color:var(--accent)">${active + inProg}</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:#dcfce7;color:#15803d"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
        <div class="stat-val" style="color:var(--success)">${done}</div>
        <div class="stat-label">Completed</div>
      </div>
    `;

    if (!moves.length) {
      list.innerHTML = `<div class="empty"><div class="empty-icon">üóÇÔ∏è</div><div class="empty-title">No moves assigned yet</div><div class="empty-sub">You'll see customer moves here once assigned by admin</div></div>`;
      return;
    }
    list.innerHTML = moves.map(m => {
      const isPending = ['payment_pending','created'].includes(m.status);
      const info = STATUS_LABELS[m.status] || { label: m.status, color: 'var(--sub)', icon: 'üì¶' };
      const totalBoxes = parseInt(m.total_boxes) || 0;
      const deliveredBoxes = parseInt(m.delivered_boxes) || 0;
      const totalFurniture = parseInt(m.total_furniture) || 0;
      const deliveredFurniture = parseInt(m.delivered_furniture) || 0;
      const totalItems = totalBoxes + totalFurniture;
      const deliveredItems = deliveredBoxes + deliveredFurniture;
      const progress = totalItems > 0 ? Math.round((deliveredItems/totalItems)*100) : 0;
      return `
      <div class="agent-move-card" onclick="openMove('${m.id}')">
        <div class="agent-card-top">
          <div>
            <div style="font-size:11px;font-weight:700;letter-spacing:0.5px;color:var(--sub);text-transform:uppercase;margin-bottom:4px">Customer</div>
            <div class="agent-card-customer">${m.user_name||'Unknown'}</div>
            ${m.customer_phone ? `<div class="agent-card-phone">üìû ${m.customer_phone}</div>` : ''}
          </div>
          <span class="move-card-badge status-badge-${m.status}">${info.label}</span>
        </div>
        <div style="margin-bottom:10px">
          <div style="font-weight:600;font-size:14px;margin-bottom:4px">${m.title||'Unnamed Move'}</div>
          <div class="move-card-route"><span class="from">${m.from_address||'‚Äî'}</span><span class="arrow">‚Üí</span><span class="to">${m.to_address||'‚Äî'}</span></div>
        </div>
        ${totalItems > 0 ? `
        <div class="agent-card-boxes">
          <div style="flex:1;min-width:0">
            <div style="display:flex;gap:12px;margin-bottom:6px;font-size:12px">
              ${totalBoxes > 0 ? `<span>üì¶ ${deliveredBoxes}/${totalBoxes} boxes</span>` : ''}
              ${totalFurniture > 0 ? `<span>üõãÔ∏è ${deliveredFurniture}/${totalFurniture} furniture</span>` : ''}
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="agent-card-progress" style="flex:1"><div class="agent-card-progress-fill" style="width:${progress}%"></div></div>
              <span style="font-size:12px;font-weight:700;color:${progress===100?'var(--success)':'var(--text)'}">${progress}%</span>
            </div>
          </div>
        </div>` : '<div style="font-size:12px;color:var(--dim)">No boxes tracked yet</div>'}
        ${isPending ? `
        <div style="margin-top:12px">
          <button onclick="event.stopPropagation();openCashModal('${m.id}')" style="width:100%;padding:10px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;color:var(--accent);font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
            üíµ Mark Cash Received
          </button>
        </div>` : ''}
      </div>`;
    }).join('');
  } catch(e) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ MOVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMoves() {
  const list = document.getElementById('movesList');
  list.innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
  try {
    const moves = await api('GET', '/api/moves');

    // Desktop KPI banner
    const banner = document.getElementById('homeStatsBanner');
    const secTitle = document.getElementById('homeSectionTitle');
    if (banner && isDesktop()) {
      const active = moves.filter(m => m.status === 'active' || m.status === 'in_progress').length;
      const pending = moves.filter(m => ['payment_pending','created'].includes(m.status)).length;
      const totalBoxes = moves.reduce((s,m) => s + (parseInt(m.total_boxes)||0), 0);
      const delivered = moves.reduce((s,m) => s + (parseInt(m.delivered_boxes)||0), 0);
      banner.style.display = 'grid';
      if (secTitle) secTitle.style.display = 'block';
      banner.innerHTML = `
        <div class="kpi-card">
          <div class="kpi-icon" style="background:#eff6ff;color:var(--accent)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
          <div class="kpi-val">${moves.length}</div>
          <div class="kpi-label">Total Moves</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="background:#dcfce7;color:#15803d"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
          <div class="kpi-val" style="color:#15803d">${active}</div>
          <div class="kpi-label">Active</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="background:#fef3c7;color:#b45309"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>
          <div class="kpi-val" style="color:#b45309">${pending}</div>
          <div class="kpi-label">Payment Pending</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon" style="background:#f0fdf4;color:#166534"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div>
          <div class="kpi-val" style="color:#166534">${delivered}/${totalBoxes}</div>
          <div class="kpi-label">Boxes Delivered</div>
        </div>`;
    }

    if (!moves.length) {
      list.innerHTML = `<div class="empty"><div class="empty-icon">üè†</div><div class="empty-title">No moves yet</div><div class="empty-sub">Click + New Move to create your first move</div></div>`;
      return;
    }
    list.innerHTML = moves.map(m => {
      const isPending = ['payment_pending', 'created'].includes(m.status);
      const isVerifying = m.status === 'payment_under_verification';
      const s = STATUS_LABELS[m.status] || { label: m.status, color: 'var(--sub)', icon: 'üì¶' };
      const statusClass = m.status === 'active' ? 'status-active' : isPending ? 'status-pending' : m.status === 'completed' ? 'status-completed' : '';
      const badgeClass = 'status-badge-' + m.status;
      const dateStr = m.move_date ? new Date(m.move_date).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}) : null;
      return `
      <div class="move-card ${statusClass}" onclick="openMove('${m.id}')">
        <div class="move-card-header">
          <div class="move-card-title">${m.title || 'Unnamed Move'}</div>
          <span class="move-card-badge ${badgeClass}">${s.label}</span>
        </div>
        <div class="move-card-route">
          <span class="from">${m.from_address || 'Origin not set'}</span>
          <span class="arrow">‚Üí</span>
          <span class="to">${m.to_address || 'Destination not set'}</span>
        </div>
        <div class="move-card-footer">
          <div class="move-card-stats">
            <span class="move-card-stat">üì¶ ${m.total_boxes||0} boxes</span>
            ${m.total_boxes > 0 ? `<span class="move-card-stat" style="color:var(--success)">‚úì ${m.delivered_boxes||0} delivered</span>` : ''}
          </div>
          ${dateStr ? `<span class="move-card-date">üìÖ ${dateStr}</span>` : ''}
        </div>
        ${isPending ? `<div onclick="openPaymentScreen('${m.id}')" style="margin-top:10px;padding:9px 12px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;font-size:12px;color:#b45309;display:flex;justify-content:space-between;align-items:center;cursor:pointer">
          <span>${parseFloat(m.estimated_cost||0) > 0 ? `üîê Pay ‚Çπ${Math.round(parseFloat(m.estimated_cost)*0.1).toLocaleString('en-IN')} token to confirm` : '‚è≥ Awaiting price confirmation'}</span>
          <span style="font-weight:700;color:var(--accent)">${parseFloat(m.estimated_cost||0) > 0 ? 'Pay Now ‚Üí' : 'View ‚Üí'}</span>
        </div>` : ''}
        ${isVerifying ? `<div style="margin-top:10px;padding:9px 12px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;font-size:12px;color:#1d4ed8">
          üîç Payment under verification by admin
        </div>` : ''}
      </div>`;
    }).join('');
  } catch(e) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Failed to load</div><div class="empty-sub">${e.message}</div></div>`;
  }
}

async function openMove(id) {
  showScreen('move');
  setTopbar('move');
  const content = document.getElementById('moveDetailContent');
  content.innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
  try {
    const m = await api('GET', `/api/moves/${id}`);
    currentMove = m;
    const boxes = await api('GET', `/api/boxes/move/${id}`);
    const furniture = await api('GET', `/api/furniture/move/${id}`);
    const delivered = boxes.filter(b => b.status === 'delivered').length;
    const paid = isActive(m);
    const isPending = ['payment_pending', 'created'].includes(m.status);
    const s = STATUS_LABELS[m.status] || { label: m.status, color: 'var(--sub)', icon: 'üì¶' };

    content.innerHTML = `
      <div class="move-detail-layout">
        <!-- LEFT: Main info -->
        <div class="move-detail-main">
          <!-- Title + status -->
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:16px">
            <div>
              <div class="section-head" style="margin-bottom:4px">${m.title || 'Unnamed Move'}</div>
              <span class="move-card-badge status-badge-${m.status}">${s.label}</span>
            </div>
            <span style="font-size:32px;flex-shrink:0">${s.icon}</span>
          </div>

          <!-- Route -->
          <div class="detail-card" style="margin-bottom:16px">
            <div class="detail-card-label">Route</div>
            <div style="display:flex;gap:12px;align-items:center">
              <div style="flex:1">
                <div style="font-size:10px;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">From</div>
                <div style="font-size:14px;font-weight:500">${m.from_address || '‚Äî'}</div>
              </div>
              <div style="color:var(--accent);font-size:20px">‚Üí</div>
              <div style="flex:1;text-align:right">
                <div style="font-size:10px;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">To</div>
                <div style="font-size:14px;font-weight:500">${m.to_address || '‚Äî'}</div>
              </div>
            </div>
            ${m.move_date ? `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:13px;color:var(--sub)">üìÖ Moving date: <strong style="color:var(--text)">${new Date(m.move_date).toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</strong></div>` : ''}
          </div>

          <!-- Stats -->
          <div class="stat-grid" style="margin-bottom:16px">
            <div class="stat-card"><div class="stat-icon">üì¶</div><div class="stat-val">${boxes.length}</div><div class="stat-label">Total Boxes</div></div>
            <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-val" style="color:var(--success)">${delivered}</div><div class="stat-label">Delivered</div></div>
            <div class="stat-card"><div class="stat-icon">‚è≥</div><div class="stat-val" style="color:var(--warn)">${boxes.length-delivered}</div><div class="stat-label">Remaining</div></div>
            <div class="stat-card"><div class="stat-icon">üõãÔ∏è</div><div class="stat-val" style="color:var(--accent2)">${furniture.length}</div><div class="stat-label">Furniture</div></div>
          </div>

          ${isPending ? `
          <div class="payment-gate" style="margin-bottom:16px">
            <div class="gate-icon">${parseFloat(m.estimated_cost||0) > 0 ? 'üîê' : '‚è≥'}</div>
            <div class="gate-title">${parseFloat(m.estimated_cost||0) > 0 ? `Pay ‚Çπ${Math.round(parseFloat(m.estimated_cost)*0.1).toLocaleString('en-IN')} Token to Confirm Booking` : 'Awaiting Price Confirmation'}</div>
            <div class="gate-sub">${parseFloat(m.estimated_cost||0) > 0 ? `Total: ‚Çπ${parseFloat(m.estimated_cost).toLocaleString('en-IN')} ¬∑ Token is 10% to activate your booking` : 'Admin will confirm your price shortly. You\'ll be notified.'}</div>
            <button class="btn btn-primary" onclick="openPaymentScreen('${m.id}')" style="max-width:240px;margin:0 auto">${parseFloat(m.estimated_cost||0) > 0 ? 'Pay Token Now ‚Üí' : 'View Payment Details ‚Üí'}</button>
          </div>` : ''}
        </div>

        <!-- RIGHT: Actions sidebar -->
        <div class="move-detail-sidebar">
          <div class="detail-card">
            <div class="detail-card-label">Actions</div>
            <button class="detail-action-btn" onclick="${paid ? `openBoxes('${m.id}')` : `showPaymentGate('${m.id}')`}" ${!paid?'disabled':''}>
              <span class="icon">üì¶</span>
              <span class="label">${!paid?'üîí ':''}Manage Boxes</span>
              <span class="count">${boxes.length}</span>
            </button>
            <button class="detail-action-btn" onclick="${paid ? `openFurniture('${m.id}')` : `showPaymentGate('${m.id}')`}" ${!paid?'disabled':''}>
              <span class="icon">üõãÔ∏è</span>
              <span class="label">${!paid?'üîí ':''}Furniture</span>
              <span class="count">${furniture.length}</span>
            </button>
            <button class="detail-action-btn" onclick="openPaymentScreen('${m.id}')">
              <span class="icon">üí≥</span>
              <span class="label">Payment & Invoice</span>
            </button>
            <button class="detail-action-btn" onclick="${paid ? `generateReport('${m.id}')` : `showPaymentGate('${m.id}')`}" ${!paid?'disabled':''} style="${paid?'background:var(--accent);color:#fff;border-color:var(--accent)':''}">
              <span class="icon">üìÑ</span>
              <span class="label">${!paid?'üîí ':''}Generate PDF Report</span>
            </button>
          </div>
          ${(user?.role === 'agent' || user?.role === 'admin') && (m.status === 'in_progress' || m.status === 'active') ? `
          <div class="detail-card" style="margin-top:12px">
            <button onclick="attemptCompleteMove('${m.id}')" style="width:100%;padding:12px;background:#dcfce7;border:1.5px solid #86efac;border-radius:10px;color:#15803d;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              Mark Move as Complete
            </button>
          </div>` : ''}
          ${m.agent_id ? `<div class="detail-card">
            <div class="detail-card-label">Assigned Agent</div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#2563eb,#7c3aed);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px;flex-shrink:0">${(m.agent_name||'A')[0].toUpperCase()}</div>
              <div style="flex:1">
                <div style="font-weight:700;font-size:14px">${m.agent_name || 'Agent Assigned'}</div>
                <div style="font-size:12px;color:var(--sub)">${m.agent_phone || m.agent_email || 'Will coordinate your move'}</div>
              </div>
              ${m.agent_phone ? `
              <div style="display:flex;gap:8px">
                <a href="tel:${m.agent_phone}" style="width:36px;height:36px;background:#dcfce7;border-radius:50%;display:flex;align-items:center;justify-content:center;text-decoration:none" title="Call">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.6 1.27h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L7.91 9a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                </a>
                <a href="https://wa.me/${m.agent_phone.replace(/\D/g,'')}" target="_blank" style="width:36px;height:36px;background:#dcfce7;border-radius:50%;display:flex;align-items:center;justify-content:center;text-decoration:none" title="WhatsApp">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="#16a34a"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z"/></svg>
                </a>
              </div>` : ''}
            </div>
          </div>` : `<div class="detail-card">
            <div class="detail-card-label">Assigned Agent</div>
            <div style="display:flex;align-items:center;gap:10px">
              <div style="width:36px;height:36px;border-radius:50%;background:#f1f5f9;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:18px">üë§</div>
              <div>
                <div style="font-weight:600;font-size:14px;color:var(--sub)">Not yet assigned</div>
                <div style="font-size:12px;color:var(--dim)">Admin will assign an agent soon</div>
              </div>
            </div>
          </div>`}
        </div>
      </div>
    `;
  } catch(e) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`;
  }
}

function openCreateMove() {
  document.getElementById('newMoveDate').value = new Date().toISOString().split('T')[0];
  openModal('createMoveModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT FLOW ‚Äî Address Autocomplete
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let addrCache = {}, addrTimers = {}, moveGeo = { from:{}, to:{} };

async function addressAutocomplete(input, suggestId, side) {
  const q = input.value.trim();
  const box = document.getElementById(suggestId);
  if (q.length < 3) { box.style.display = 'none'; return; }
  clearTimeout(addrTimers[side]);
  addrTimers[side] = setTimeout(async () => {
    try {
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&addressdetails=1&limit=5&countrycodes=in`;
      const r = await fetch(url, { headers: { 'Accept-Language': 'en', 'User-Agent': 'MoveAssist/1.0' } });
      const results = await r.json();
      if (!results.length) { box.style.display = 'none'; return; }
      box.innerHTML = results.map(item => {
        const city = item.address?.city || item.address?.town || item.address?.village || item.address?.county || '';
        const state = item.address?.state || '';
        const display = item.display_name.split(',').slice(0,3).join(',');
        return `<div class="address-suggestion-item" onclick="selectAddress('${side}','${display.replace(/'/g,"\\'")}','${city.replace(/'/g,"\\'")}',${item.lat},${item.lon})">${display}</div>`;
      }).join('');
      box.style.display = 'block';
    } catch(e) { box.style.display = 'none'; }
  }, 350);
}

function selectAddress(side, display, city, lat, lon) {
  document.getElementById(side === 'from' ? 'newMoveFrom' : 'newMoveTo').value = display;
  document.getElementById(side === 'from' ? 'fromSuggestions' : 'toSuggestions').style.display = 'none';
  moveGeo[side] = { city, lat, lon };
  checkIntraCity();
}

function checkIntraCity() {
  const warn = document.getElementById('intraCityWarning');
  const btn = document.getElementById('createMoveNextBtn');
  if (moveGeo.from.city && moveGeo.to.city) {
    const same = moveGeo.from.city.toLowerCase().trim() === moveGeo.to.city.toLowerCase().trim();
    // Only block if feature flag is enabled (checked on server) ‚Äî show warning optimistically
    warn.style.display = same ? 'none' : '';
    warn.textContent = `‚ö†Ô∏è We currently only support moves within the same city. Detected: ${moveGeo.from.city} ‚Üí ${moveGeo.to.city}.`;
  }
}

async function useMyLocation() {
  const btn = document.getElementById('gpsBtn');
  if (!navigator.geolocation) { toast('Geolocation not supported by your browser', 'error'); return; }
  btn.innerHTML = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/></svg> Locating...`;
  btn.disabled = true;
  navigator.geolocation.getCurrentPosition(async pos => {
    try {
      const { latitude: lat, longitude: lon } = pos.coords;
      const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`;
      const r = await fetch(url, { headers: { 'Accept-Language': 'en', 'User-Agent': 'MoveAssist/1.0' } });
      const data = await r.json();
      const addr = data.address || {};
      const city = addr.city || addr.town || addr.village || addr.county || '';
      const display = [addr.road, addr.suburb, city, addr.state].filter(Boolean).join(', ');
      document.getElementById('newMoveFrom').value = display;
      moveGeo.from = { city, lat, lon };
      checkIntraCity();
      toast('üìç Location detected!', 'success');
    } catch(e) { toast('Could not reverse geocode location', 'error'); }
    btn.innerHTML = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/></svg> Use my location`;
    btn.disabled = false;
  }, err => {
    toast('Location access denied. Please enable GPS.', 'error');
    btn.innerHTML = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/></svg> Use my location`;
    btn.disabled = false;
  }, { timeout: 10000 });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT FLOW ‚Äî BHK + Estimator
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedBHK = null, estimateData = null;

function selectBHK(bhk) {
  selectedBHK = bhk;
  ['studio','1bhk','2bhk','3bhk','4bhk'].forEach(b => {
    document.getElementById('bhk-'+b)?.classList.toggle('selected', b === bhk);
  });
  updateEstimate();
}

async function updateEstimate() {
  if (!selectedBHK) return;
  try {
    const data = await api('POST', '/api/pricing/estimate', {
      bhk_type: selectedBHK,
      num_furniture: 0, num_boxes: 0,
      floor_from: parseInt(document.getElementById('floorFrom')?.value)||0,
      floor_to: parseInt(document.getElementById('floorTo')?.value)||0,
      has_lift_from: document.getElementById('liftFrom')?.checked,
      has_lift_to: document.getElementById('liftTo')?.checked,
      has_fragile: document.getElementById('hasFragile')?.checked,
    });
    estimateData = data;
    const card = document.getElementById('estimateCard');
    const b = data.breakdown;
    card.style.display = 'block';
    document.getElementById('estimateTotal').textContent = data.display;
    document.getElementById('estimateBreakdown').innerHTML =
      `Base (${selectedBHK.toUpperCase()}): ‚Çπ${b.base.toLocaleString('en-IN')}` +
      (b.floorFrom > 0 ? ` ¬∑ Floor pickup: ‚Çπ${b.floorFrom.toLocaleString('en-IN')}` : '') +
      (b.floorTo > 0 ? ` ¬∑ Floor delivery: ‚Çπ${b.floorTo.toLocaleString('en-IN')}` : '') +
      (b.fragile > 0 ? ` ¬∑ Fragile: ‚Çπ${b.fragile.toLocaleString('en-IN')}` : '') +
      ` ¬∑ GST (18%): ‚Çπ${b.tax.toLocaleString('en-IN')}`;
  } catch(e) {}
}

async function createMoveStep2() {
  const title = document.getElementById('newMoveTitle').value.trim();
  const from = document.getElementById('newMoveFrom').value.trim();
  const to = document.getElementById('newMoveTo').value.trim();
  if (!title || !from || !to) { toast('Please fill all fields', 'error'); return; }
  document.getElementById('createStep1').style.display = 'none';
  document.getElementById('createStep2').style.display = 'block';
}

async function createMove() {
  const btn = document.getElementById('createMoveBtn');
  btn.disabled = true; btn.textContent = 'Creating...';
  try {
    const move = await api('POST', '/api/moves', {
      title: document.getElementById('newMoveTitle').value,
      from_address: document.getElementById('newMoveFrom').value,
      to_address: document.getElementById('newMoveTo').value,
      move_date: document.getElementById('newMoveDate').value,
      from_city: moveGeo.from.city || '',
      to_city: moveGeo.to.city || '',
      from_lat: moveGeo.from.lat, from_lng: moveGeo.from.lon,
      to_lat: moveGeo.to.lat, to_lng: moveGeo.to.lon,
      floor_from: parseInt(document.getElementById('floorFrom')?.value)||0,
      floor_to: parseInt(document.getElementById('floorTo')?.value)||0,
      has_lift_from: document.getElementById('liftFrom')?.checked||false,
      has_lift_to: document.getElementById('liftTo')?.checked||false,
      bhk_type: selectedBHK,
    });
    // Save pricing estimate
    if (estimateData && move.id) {
      const b = estimateData.breakdown;
      await api('POST', '/api/pricing/save', {
        move_id: move.id, base_price: b.base, num_rooms: 0,
        has_fragile: document.getElementById('hasFragile')?.checked||false,
        fragile_surcharge: b.fragile, floor_surcharge: b.floorFrom+b.floorTo,
        tax_percent: 18, discount: 0, total: b.total
      });
    }
    closeModal('createMoveModal');
    loadMoves();
    toast('Move created! üéâ', 'success');
    // Reset form
    ['newMoveTitle','newMoveFrom','newMoveTo'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
    moveGeo = { from:{}, to:{} }; selectedBHK = null; estimateData = null;
    document.getElementById('createStep1').style.display = '';
    document.getElementById('createStep2').style.display = 'none';
  } catch(e) {
    if (e.message?.includes('INTRA_CITY_ONLY')) {
      toast('Only same-city moves are currently supported', 'error');
      document.getElementById('createStep2').style.display = 'none';
      document.getElementById('createStep1').style.display = '';
    } else {
      toast(e.message, 'error');
    }
  }
  btn.disabled = false; btn.textContent = 'Create Move üéâ';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT FLOW ‚Äî Notifications
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadNotifCount() {
  try {
    const r = await api('GET', '/api/notifications/unread-count');
    const badge = document.getElementById('notifBadge');
    const bell = document.getElementById('notifBell');
    if (bell) bell.style.display = 'block';
    if (badge) {
      if (r.count > 0) { badge.textContent = r.count > 9 ? '9+' : r.count; badge.style.display = 'flex'; }
      else badge.style.display = 'none';
    }
  } catch(e) {}
}

async function openNotifications() {
  openModal('notifPanel');
  const list = document.getElementById('notifList');
  list.innerHTML = '<div style="text-align:center;padding:32px"><div class="spinner"></div></div>';
  try {
    const notifs = await api('GET', '/api/notifications');
    if (!notifs.length) {
      list.innerHTML = '<div style="text-align:center;padding:32px;color:var(--sub)">No notifications yet</div>';
      return;
    }
    const icons = { box_scanned:'üì¶', furniture_delivered:'üõãÔ∏è', move_completed:'‚úÖ', condition_change:'‚ö†Ô∏è', dispute_raised:'üö®', rating_received:'‚≠ê', move_created:'üè†' };
    list.innerHTML = notifs.map(n => `
      <div class="notif-item ${n.read?'':'unread'}" onclick="markNotifRead('${n.id}',this)">
        <div style="display:flex;gap:10px;align-items:flex-start">
          <span style="font-size:20px">${icons[n.type]||'üîî'}</span>
          <div style="flex:1;min-width:0">
            <div style="font-size:13px;font-weight:${n.read?'500':'700'};color:var(--text)">${n.title}</div>
            ${n.body ? `<div style="font-size:12px;color:var(--sub);margin-top:2px">${n.body}</div>` : ''}
            <div style="font-size:11px;color:var(--dim);margin-top:4px">${timeAgo(n.created_at)}</div>
          </div>
          ${!n.read ? '<div style="width:8px;height:8px;background:var(--accent);border-radius:50%;flex-shrink:0;margin-top:4px"></div>' : ''}
        </div>
      </div>`).join('');
  } catch(e) { list.innerHTML = `<div style="color:var(--error);padding:16px">${e.message}</div>`; }
}

async function markNotifRead(id, el) {
  await api('POST', '/api/notifications/mark-read', { ids: [id] });
  el.classList.remove('unread');
  loadNotifCount();
}

async function markAllNotifsRead() {
  await api('POST', '/api/notifications/mark-all-read');
  document.querySelectorAll('.notif-item.unread').forEach(el => el.classList.remove('unread'));
  document.getElementById('notifBadge').style.display = 'none';
}

function timeAgo(ts) {
  const diff = Date.now() - new Date(ts);
  const m = Math.floor(diff/60000), h = Math.floor(m/60), d = Math.floor(h/24);
  if (d > 0) return `${d}d ago`; if (h > 0) return `${h}h ago`;
  if (m > 0) return `${m}m ago`; return 'just now';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT FLOW ‚Äî Timeline / Activity Feed
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadTimeline(moveId) {
  const el = document.getElementById('moveTimeline');
  if (!el) return;
  el.innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner"></div></div>';
  try {
    const acts = await api('GET', `/api/activities/move/${moveId}`);
    if (!acts.length) { el.innerHTML = '<div style="color:var(--sub);font-size:13px;padding:12px 0">No activity yet</div>'; return; }
    const typeStyle = {
      move_created: { bg:'#eff6ff', color:'#2563eb', icon:'üè†' },
      box_scanned: { bg:'#fef3c7', color:'#b45309', icon:'üì¶' },
      furniture_delivered: { bg:'#f0fdf4', color:'#16a34a', icon:'üõãÔ∏è' },
      move_completed: { bg:'#dcfce7', color:'#16a34a', icon:'‚úÖ' },
      condition_change: { bg:'#fef2f2', color:'#dc2626', icon:'‚ö†Ô∏è' },
    };
    el.innerHTML = acts.reverse().map(a => {
      const s = typeStyle[a.type] || { bg:'#f1f5f9', color:'#64748b', icon:'üîî' };
      return `
      <div class="timeline-item">
        <div class="timeline-dot" style="background:${s.bg};color:${s.color}">${s.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600">${a.title}</div>
          ${a.description ? `<div style="font-size:12px;color:var(--sub);margin-top:2px">${a.description}</div>` : ''}
          <div style="font-size:11px;color:var(--dim);margin-top:3px">${timeAgo(a.created_at)} ¬∑ ${a.actor_name||a.actor_role||'System'}</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT FLOW ‚Äî Rating
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentRating = 0, ratingMoveId = null;

function openRateModal(moveId) {
  ratingMoveId = moveId;
  currentRating = 0;
  [1,2,3,4,5].forEach(n => { document.getElementById('star-'+n).style.opacity = '0.3'; });
  document.getElementById('ratingReview').value = '';
  openModal('rateMoveModal');
}

function setRating(n) {
  currentRating = n;
  [1,2,3,4,5].forEach(i => { document.getElementById('star-'+i).style.opacity = i <= n ? '1' : '0.3'; });
}

async function submitRating() {
  if (!currentRating) { toast('Please select a star rating', 'error'); return; }
  const btn = document.getElementById('submitRatingBtn');
  btn.disabled = true; btn.textContent = 'Submitting...';
  try {
    await api('POST', `/api/ratings/move/${ratingMoveId}`, {
      rating: currentRating, review: document.getElementById('ratingReview').value
    });
    closeModal('rateMoveModal');
    toast(`Thanks for your ${currentRating}‚òÖ rating! üôè`, 'success');
    openMove(ratingMoveId);
  } catch(e) { toast(e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'Submit Rating';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT FLOW ‚Äî Dispute
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let disputePhotoDataUrl = null, disputeMoveId = null;

async function openDisputeModal(moveId) {
  disputeMoveId = moveId; disputePhotoDataUrl = null;
  document.getElementById('disputeDesc').value = '';
  document.getElementById('disputePhotoPreview').style.display = 'none';
  // Populate furniture
  try {
    const furn = await api('GET', `/api/furniture/move/${moveId}`);
    const sel = document.getElementById('disputeFurnSelect');
    sel.innerHTML = '<option value="">Select furniture item (optional)</option>';
    furn.forEach(f => sel.innerHTML += `<option value="${f.id}">${f.name}</option>`);
  } catch(e) {}
  openModal('disputeModal');
}

function handleDisputePhoto(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    disputePhotoDataUrl = e.target.result;
    document.getElementById('disputePhotoImg').src = disputePhotoDataUrl;
    document.getElementById('disputePhotoPreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

async function submitDispute() {
  const desc = document.getElementById('disputeDesc').value.trim();
  if (!desc) { toast('Please describe the issue', 'error'); return; }
  const btn = document.getElementById('submitDisputeBtn');
  btn.disabled = true; btn.textContent = 'Submitting...';
  try {
    await api('POST', `/api/disputes/move/${disputeMoveId}`, {
      furniture_id: document.getElementById('disputeFurnSelect').value || null,
      description: desc,
      client_photo_url: disputePhotoDataUrl || null
    });
    closeModal('disputeModal');
    toast('Dispute submitted. Our team will review it shortly.', 'success');
  } catch(e) { toast(e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'Submit Dispute';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT FLOW ‚Äî Document Vault
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let docFileDataUrl = null, docVaultMoveId = null;

async function openDocVault(moveId) {
  docVaultMoveId = moveId;
  docFileDataUrl = null;
  document.getElementById('docName').value = '';
  openModal('docVaultModal');
  await loadDocVault(moveId);
}

async function loadDocVault(moveId) {
  const list = document.getElementById('docVaultList');
  list.innerHTML = '';
  try {
    const docs = await api('GET', `/api/documents/move/${moveId}`);
    if (!docs.length) { list.innerHTML = '<div style="color:var(--sub);font-size:13px;margin-bottom:8px">No documents uploaded yet</div>'; return; }
    const typeIcons = { noc:'üìú', parking:'üÖøÔ∏è', entry:'üö™', insurance:'üõ°Ô∏è', other:'üìÑ' };
    list.innerHTML = docs.map(d => `
      <div class="doc-card">
        <span style="font-size:20px">${typeIcons[d.doc_type]||'üìÑ'}</span>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600">${d.name}</div>
          <div style="font-size:11px;color:var(--sub)">${d.doc_type?.toUpperCase()} ¬∑ ${timeAgo(d.created_at)} ¬∑ ${d.uploaded_by_name}</div>
        </div>
        <a href="${d.file_url}" target="_blank" style="font-size:12px;color:var(--accent);text-decoration:none">View</a>
      </div>`).join('');
  } catch(e) {}
}

function handleDocFile(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    docFileDataUrl = e.target.result;
    document.getElementById('docFilePreview').textContent = `‚úì ${file.name}`;
    document.getElementById('docFilePreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

async function uploadDocument() {
  const name = document.getElementById('docName').value.trim();
  if (!name) { toast('Document name required', 'error'); return; }
  if (!docFileDataUrl) { toast('Please select a file', 'error'); return; }
  const btn = document.getElementById('uploadDocBtn');
  btn.disabled = true; btn.textContent = 'Uploading...';
  try {
    await api('POST', `/api/documents/move/${docVaultMoveId}`, {
      name, doc_type: document.getElementById('docType').value, file_url: docFileDataUrl
    });
    docFileDataUrl = null;
    document.getElementById('docName').value = '';
    document.getElementById('docFilePreview').style.display = 'none';
    await loadDocVault(docVaultMoveId);
    toast('Document uploaded!', 'success');
  } catch(e) { toast(e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'Upload Document';
}

// Start polling notifications every 30s when logged in
setInterval(() => { if (token) loadNotifCount(); }, 30000);

async function updateMoveStatus(id, status) {
  try {
    const m = currentMove;
    await api('PUT', `/api/moves/${id}`, { ...m, status });
    toast('Status updated to ' + status.replace('_',' '), 'success');
    openMove(id);
  } catch(e) { toast(e.message, 'error'); }
}

async function attemptCompleteMove(id) {
  // Fetch current state for pre-flight checklist
  const [boxes, furniture] = await Promise.all([
    api('GET', `/api/boxes/move/${id}`),
    api('GET', `/api/furniture/move/${id}`)
  ]);

  const pendingBoxes        = boxes.filter(b => b.status !== 'delivered');
  const pendingFurn         = furniture.filter(f => !f.condition_after);
  const missingPickupPhoto  = furniture.filter(f => !(f.photos||[]).find(p => p.photo_type==='before'));
  const missingDelivPhoto   = furniture.filter(f => f.condition_after && !(f.photos||[]).find(p => p.photo_type==='after'));

  const checks = [
    { label: `All boxes delivered`,         ok: pendingBoxes.length === 0,       detail: pendingBoxes.length ? `${pendingBoxes.length} box${pendingBoxes.length>1?'es':''} still pending` : null },
    { label: `All furniture delivered`,     ok: pendingFurn.length === 0,         detail: pendingFurn.length ? `${pendingFurn.length} item${pendingFurn.length>1?'s':''} not marked delivered` : null },
    { label: `Delivery photos documented`,  ok: missingDelivPhoto.length === 0,   detail: missingDelivPhoto.length ? `Missing for: ${missingDelivPhoto.map(f=>f.name).join(', ')}` : null },
  ];

  const allClear = checks.every(c => c.ok);

  document.getElementById('completeMoveChecklist').innerHTML = checks.map(c => `
    <div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="flex-shrink:0;width:22px;height:22px;border-radius:50%;background:${c.ok ? '#dcfce7' : '#fee2e2'};display:flex;align-items:center;justify-content:center;margin-top:1px">
        ${c.ok
          ? `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#15803d" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`
          : `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`
        }
      </div>
      <div>
        <div style="font-size:13px;font-weight:600;color:${c.ok ? 'var(--text)' : 'var(--error)'}">${c.label}</div>
        ${c.detail ? `<div style="font-size:11px;color:var(--error);margin-top:2px">${c.detail}</div>` : ''}
      </div>
    </div>
  `).join('');

  document.getElementById('completeMoveActions').innerHTML = allClear
    ? `<button onclick="confirmCompleteMove('${id}')" id="confirmCompleteBtn" class="btn btn-primary" style="background:#16a34a;border-color:#16a34a">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:6px"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        Confirm ‚Äî Mark as Complete
       </button>`
    : `<div style="font-size:12px;color:var(--sub);text-align:center;padding:8px 0">Resolve all issues above to complete this move</div>`;

  openModal('completeMoveModal');
}

async function confirmCompleteMove(id) {
  const btn = document.getElementById('confirmCompleteBtn');
  btn.disabled = true; btn.textContent = 'Completing...';
  try {
    await api('POST', `/api/moves/${id}/complete`, {});
    toast('üéâ Move marked as complete!', 'success');
    closeModal('completeMoveModal');
    openMove(id);
  } catch(e) {
    toast(e.message || 'Could not complete move', 'error');
    btn.disabled = false; btn.textContent = 'Confirm ‚Äî Mark as Complete';
  }
}

// ‚îÄ‚îÄ‚îÄ BOXES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openBoxes(moveId) {
  currentMove = currentMove || { id: moveId };
  showScreen('boxes');
  setTopbar('boxes');
  document.getElementById('boxesMoveTitle').textContent = currentMove?.title || '';
  await loadBoxes(moveId);
}

async function loadBoxes(moveId) {
  const id = moveId || currentMove?.id;
  const list = document.getElementById('boxesList');
  list.innerHTML = '<div style="text-align:center;padding:30px"><div class="spinner"></div></div>';
  selectedBoxIds.clear();
  updateBulkBar();
  try {
    const boxes = await api('GET', `/api/boxes/move/${id}`);
    if (!boxes.length) {
      list.innerHTML = `<div class="empty"><div class="empty-icon">üì¶</div><div class="empty-title">No boxes yet</div><div class="empty-sub">Tap + Box to add your first</div></div>`;
      return;
    }
    const catIcon = {
      kitchen:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M8 3v4a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3"/><rect x="2" y="8" width="20" height="13" rx="2"/><line x1="2" y1="13" x2="22" y2="13"/></svg>`,
      bedroom:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M2 9V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4"/><path d="M2 9h20v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9z"/><line x1="2" y1="14" x2="22" y2="14"/></svg>`,
      electronics: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8m-4-4v4"/></svg>`,
      fragile:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M12 2l3 7h7l-5.5 4 2 7L12 17l-6.5 3 2-7L2 9h7z"/></svg>`,
      clothes:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.57a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.57a2 2 0 0 0-1.34-2.23z"/></svg>`,
      books:       `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>`,
      bathroom:    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M9 6a3 3 0 1 0 0-6"/><path d="M9 6H3v12a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V6H9z"/><line x1="3" y1="11" x2="21" y2="11"/></svg>`,
      general:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>`,
    };
    const statusOrder = ['created','packed','loaded','in_transit','delivered'];
    list.innerHTML = boxes.map(b => {
      const nextStatus = statusOrder[statusOrder.indexOf(b.status) + 1];
      return `
      <div class="box-item" id="boxitem-${b.id}" style="position:relative;cursor:default">
        <div style="display:flex;align-items:center;gap:10px;flex:1" onclick="openBoxDetail('${b.id}')">
          <div class="box-icon">${catIcon[b.category]||'üì¶'}</div>
          <div class="box-info" style="flex:1;min-width:0">
            <div class="box-label">${b.label || 'Unlabeled Box'}</div>
            <div class="box-meta">${b.contents || b.category || ''}</div>
          </div>
          <span class="badge badge-${b.status}" style="flex-shrink:0">${b.status.replace('_',' ')}</span>
        </div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          ${nextStatus ? `<button onclick="quickStatusUpdate('${b.id}','${nextStatus}',this)" style="flex:1;padding:6px 10px;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-family:inherit;font-size:11px;font-weight:700;cursor:pointer">‚Üí ${nextStatus.replace('_',' ')}</button>
          <label style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--sub);cursor:pointer;flex-shrink:0">
            <input type="checkbox" id="chk-${b.id}" onchange="toggleBoxSelect('${b.id}',this.checked)" style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer"/>
            Select
          </label>` : `<span style="font-size:11px;color:var(--success);font-weight:600">‚úì All done</span>`}
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`;
  }
}

function openAddBox() { openModal('addBoxModal'); }

// ‚îÄ‚îÄ BULK SELECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedBoxIds = new Set();
let bulkSelectedStatus = '';
let scanPhotoDataUrl = null;
let bulkPhotoDataUrl = null;

function toggleBoxSelect(id, checked) {
  if (checked) selectedBoxIds.add(id);
  else selectedBoxIds.delete(id);
  const item = document.getElementById('boxitem-' + id);
  if (item) item.style.background = checked ? 'rgba(37,99,235,0.06)' : '';
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulkBar');
  const count = document.getElementById('bulkCount');
  if (!bar) return;
  if (selectedBoxIds.size > 0) {
    bar.style.display = 'flex';
    count.textContent = `${selectedBoxIds.size} box${selectedBoxIds.size > 1 ? 'es' : ''} selected`;
  } else {
    bar.style.display = 'none';
  }
}

function selectAllBoxes() {
  document.querySelectorAll('#boxesList input[type=checkbox]').forEach(chk => {
    chk.checked = true;
    const id = chk.id.replace('chk-','');
    selectedBoxIds.add(id);
    const item = document.getElementById('boxitem-' + id);
    if (item) item.style.background = 'rgba(37,99,235,0.06)';
  });
  updateBulkBar();
}

function clearSelection() {
  selectedBoxIds.clear();
  document.querySelectorAll('#boxesList input[type=checkbox]').forEach(chk => {
    chk.checked = false;
    const id = chk.id.replace('chk-','');
    const item = document.getElementById('boxitem-' + id);
    if (item) item.style.background = '';
  });
  updateBulkBar();
}

function openBulkUpdate() {
  if (!selectedBoxIds.size) return;
  document.getElementById('bulkModalSubtitle').textContent = `Updating ${selectedBoxIds.size} box${selectedBoxIds.size > 1 ? 'es' : ''}`;
  bulkSelectedStatus = '';
  bulkPhotoDataUrl = null;
  document.getElementById('bulkLocation').value = '';
  document.getElementById('bulkNotes').value = '';
  document.getElementById('bulkPhotoPreview').style.display = 'none';
  const STATUSES = ['packed','loaded','in_transit','delivered'];
  document.getElementById('bulkStatusChips').innerHTML = STATUSES.map(s =>
    `<div class="chip" onclick="selectBulkStatus('${s}',this)">${s.replace('_',' ')}</div>`
  ).join('');
  openModal('bulkUpdateModal');
}

function selectBulkStatus(s, el) {
  bulkSelectedStatus = s;
  document.querySelectorAll('#bulkStatusChips .chip').forEach(c => c.classList.remove('sel'));
  el.classList.add('sel');
}

async function submitBulkUpdate() {
  if (!bulkSelectedStatus) { toast('Select a status first', 'error'); return; }
  const btn = document.getElementById('bulkSubmitBtn');
  btn.disabled = true; btn.textContent = 'Updating...';
  try {
    const result = await api('POST', '/api/boxes/bulk-scan', {
      box_ids: [...selectedBoxIds],
      status: bulkSelectedStatus,
      location: document.getElementById('bulkLocation').value,
      notes: document.getElementById('bulkNotes').value,
      photo_url: bulkPhotoDataUrl || null,
    });
    toast(result.message + ' ‚úì', 'success');
    closeModal('bulkUpdateModal');
    clearSelection();
    await loadBoxes();
  } catch(e) { toast(e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'Update Boxes';
}

function handleBulkPhotoSelect(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    bulkPhotoDataUrl = e.target.result;
    document.getElementById('bulkPhotoPreviewImg').src = bulkPhotoDataUrl;
    document.getElementById('bulkPhotoPreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function clearBulkPhoto() {
  bulkPhotoDataUrl = null;
  document.getElementById('bulkPhoto').value = '';
  document.getElementById('bulkPhotoPreview').style.display = 'none';
}

async function quickStatusUpdate(boxId, status, btn) {
  btn.disabled = true; btn.textContent = '...';
  try {
    await api('PUT', `/api/boxes/${boxId}/status`, { status });
    toast(`‚Üí ${status.replace('_',' ')} ‚úì`, 'success');
    await loadBoxes();
  } catch(e) { toast(e.message, 'error'); btn.disabled = false; }
}

// ‚îÄ‚îÄ PHOTO PROOF (scan form) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handlePhotoSelect(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    scanPhotoDataUrl = e.target.result;
    document.getElementById('photoPreviewImg').src = scanPhotoDataUrl;
    document.getElementById('photoPreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function clearPhoto() {
  scanPhotoDataUrl = null;
  document.getElementById('scanPhoto').value = '';
  document.getElementById('photoPreview').style.display = 'none';
}

async function addBox() {
  const btn = document.getElementById('addBoxBtn');
  btn.disabled = true; btn.textContent = 'Generating QR...';
  try {
    const box = await api('POST', `/api/boxes/move/${currentMove.id}`, {
      label: document.getElementById('newBoxLabel').value,
      category: document.getElementById('newBoxCategory').value,
      contents: document.getElementById('newBoxContents').value,
    });
    closeModal('addBoxModal');
    toast('Box created with QR code!', 'success');
    ['newBoxLabel','newBoxContents'].forEach(id => document.getElementById(id).value = '');
    await loadBoxes();
    openBoxDetail(box.id, box);
  } catch(e) { toast(e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'Add Box + Generate QR';
}

async function openBoxDetail(id, boxData) {
  showScreen('box-detail');
  const content = document.getElementById('boxDetailContent');
  content.innerHTML = '<div style="text-align:center;padding:30px"><div class="spinner"></div></div>';
  try {
    const box = boxData || await api('GET', `/api/boxes/qr/${id}`).catch(() => null) || { id };
    const catIcon = {
      kitchen:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M8 3v4a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3"/><rect x="2" y="8" width="20" height="13" rx="2"/><line x1="2" y1="13" x2="22" y2="13"/></svg>`,
      bedroom:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M2 9V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4"/><path d="M2 9h20v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9z"/><line x1="2" y1="14" x2="22" y2="14"/></svg>`,
      electronics: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8m-4-4v4"/></svg>`,
      fragile:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M12 2l3 7h7l-5.5 4 2 7L12 17l-6.5 3 2-7L2 9h7z"/></svg>`,
      clothes:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.57a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.57a2 2 0 0 0-1.34-2.23z"/></svg>`,
      books:       `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>`,
      bathroom:    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M9 6a3 3 0 1 0 0-6"/><path d="M9 6H3v12a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V6H9z"/><line x1="3" y1="11" x2="21" y2="11"/></svg>`,
      general:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="22" height="22"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>`,
    };

    let qrHtml = '';
    if (box.qr_image_url?.startsWith('data:image')) {
      qrHtml = `<div class="qr-container">
        <img src="${box.qr_image_url}" alt="QR Code"/>
        <div style="font-size:11px;color:#666;font-family:monospace;word-break:break-all;text-align:center">${box.qr_code}</div>
        <button class="btn btn-secondary" onclick="navigator.share({title:'Box QR',text:'${box.label||'Box'}',url:window.location.href}).catch(()=>{})" style="width:auto;padding:8px 16px;font-size:12px">Share QR</button>
      </div>`;
    }

    const scanHistory = box.scan_history || [];
    const scansHtml = scanHistory.length ? scanHistory.map(s => `
      <div class="scan-log-item">
        <div class="scan-dot"></div>
        <div style="flex:1">
          <div class="scan-log-status">${s.status?.toUpperCase()}</div>
          ${s.location ? `<div class="scan-log-note">üìç ${s.location}</div>` : ''}
          ${s.notes ? `<div class="scan-log-note">${s.notes}</div>` : ''}
          <div class="scan-log-time">${new Date(s.scanned_at).toLocaleString('en-IN')}</div>
          ${s.photo_url ? `<img src="${s.photo_url}" style="width:100%;max-height:160px;object-fit:cover;border-radius:8px;margin-top:8px;border:1px solid var(--border)"/>` : ''}
        </div>
      </div>
    `).join('') : '<div style="color:var(--dim);font-size:13px;padding:8px 0">No scans yet</div>';

    const isCustomer = !user?.role || user?.role === 'customer';

    content.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
        <div style="font-size:36px">${catIcon[box.category]||'üì¶'}</div>
        <div>
          <div style="font-size:20px;font-weight:700">${box.label||'Unlabeled'}</div>
          <span class="badge badge-${box.status}">${box.status}</span>
        </div>
      </div>
      ${box.contents ? `<div class="card card-sm" style="margin-bottom:12px"><div style="font-size:11px;color:var(--sub);margin-bottom:4px">CONTENTS</div><div style="font-size:14px">${box.contents}</div></div>` : ''}
      ${qrHtml}
      <div class="card">
        <div style="font-size:12px;font-weight:600;color:var(--sub);margin-bottom:12px;letter-spacing:0.5px">SCAN HISTORY</div>
        ${scansHtml}
      </div>
      ${!isCustomer ? `<button class="btn btn-primary" style="margin-top:12px" onclick="quickScanBox('${box.qr_code}')">üì∑ Update Status</button>` : ''}
    `;
  } catch(e) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`;
  }
}

function quickScanBox(qrCode) {
  navTo('scan');
  document.getElementById('manualQR').value = qrCode;
  setTimeout(() => lookupManualQR(), 300);
}

// ‚îÄ‚îÄ‚îÄ FURNITURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openFurniture(moveId) {
  showScreen('furniture');
  setTopbar('furniture');
  document.getElementById('furnMoveTitle').textContent = currentMove?.title || '';
  // Hide add button for customers ‚Äî read-only view
  const addBtn = document.getElementById('addFurnBtn2');
  if (addBtn) addBtn.style.display = (user?.role === 'agent' || user?.role === 'admin') ? '' : 'none';
  await loadFurniture(moveId);
}

async function loadFurniture(moveId) {
  const id = moveId || currentMove?.id;
  const list = document.getElementById('furnitureList');
  list.innerHTML = '<div style="text-align:center;padding:30px"><div class="spinner"></div></div>';
  try {
    const items = await api('GET', `/api/furniture/move/${id}`);
    const catSvg = {
      sofa:      `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="20" height="20"><path d="M20 9V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/><path d="M2 11a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6H2v-6z"/><path d="M4 17v2m16-2v2"/></svg>`,
      bed:       `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="20" height="20"><path d="M2 9V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4"/><path d="M2 9h20v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9z"/><line x1="2" y1="14" x2="22" y2="14"/></svg>`,
      table:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="20" height="20"><rect x="3" y="6" width="18" height="4" rx="1"/><line x1="7" y1="10" x2="7" y2="18"/><line x1="17" y1="10" x2="17" y2="18"/></svg>`,
      chair:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="20" height="20"><path d="M5 4h14v8H5z"/><path d="M3 12h18v3H3z"/><line x1="7" y1="15" x2="7" y2="20"/><line x1="17" y1="15" x2="17" y2="20"/></svg>`,
      wardrobe:  `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="20" height="20"><rect x="2" y="2" width="20" height="20" rx="2"/><line x1="12" y1="2" x2="12" y2="22"/><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/></svg>`,
      appliance: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="20" height="20"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="5" y1="8" x2="19" y2="8"/><circle cx="12" cy="15" r="2"/></svg>`,
      tv:        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="20" height="20"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8m-4-4v4"/></svg>`,
      other:     `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="20" height="20"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>`,
    };
    const condColor = { excellent:'var(--success)', good:'var(--accent2)', fair:'var(--warn)', poor:'var(--error)' };
    if (!items.length) {
      list.innerHTML = `<div class="empty"><div class="empty-icon" style="font-size:36px">üõãÔ∏è</div><div class="empty-title">No furniture yet</div><div class="empty-sub">Document items before the move</div></div>`;
      return;
    }
    list.innerHTML = items.map(f => {
      const photos = f.photos || [];
      const beforePhoto = photos.find(p => p.photo_type === 'before');
      const afterPhoto  = photos.find(p => p.photo_type === 'after');
      const delivered   = !!f.condition_after;
      return `
      <div class="card" style="padding:14px;margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div class="box-icon" style="flex-shrink:0">${catSvg[f.category]||catSvg.other}</div>
          <div style="flex:1;min-width:0">
            <div style="font-weight:700;font-size:15px">${f.name}</div>
            <div style="font-size:12px;margin-top:2px;display:flex;gap:8px;flex-wrap:wrap">
              <span style="color:${condColor[f.condition_before]||'var(--sub)'}">Before: ${f.condition_before||'‚Äî'}</span>
              ${delivered ? `<span>‚Üí</span><span style="color:${condColor[f.condition_after]}">After: ${f.condition_after}</span>` : ''}
            </div>
            ${f.damage_notes ? `<div style="font-size:11px;color:var(--error);margin-top:3px">‚ö†Ô∏è ${f.damage_notes}</div>` : ''}
          </div>
          ${delivered
            ? `<span style="font-size:11px;font-weight:700;color:var(--success);white-space:nowrap">‚úì Delivered</span>`
            : (user?.role === 'agent' || user?.role === 'admin')
              ? `<button onclick="openFurnDelivery('${f.id}','${f.name.replace(/'/g,"\\'")}');event.stopPropagation()" style="white-space:nowrap;padding:6px 12px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer">Mark Delivered</button>`
              : `<span style="font-size:11px;font-weight:600;color:var(--warn);white-space:nowrap">‚è≥ Pending</span>`
          }
        </div>
        ${(beforePhoto || afterPhoto) ? `
        <div style="display:flex;gap:8px">
          ${beforePhoto ? `<div style="flex:1"><div style="font-size:10px;color:var(--sub);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.4px">Pickup</div><img src="${beforePhoto.photo_url}" style="width:100%;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/></div>` : ''}
          ${afterPhoto  ? `<div style="flex:1"><div style="font-size:10px;color:var(--sub);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.4px">Delivery</div><img src="${afterPhoto.photo_url}" style="width:100%;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/></div>` : ''}
        </div>` : ''}
      </div>`;
    }).join('');
  } catch(e) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`;
  }
}

function openAddFurniture() {
  addFurnPhotoDataUrl = null;
  document.getElementById('addFurnPhotoPreview').style.display = 'none';
  document.getElementById('newFurnName').value = '';
  document.getElementById('newFurnDamage').value = '';
  openModal('addFurnModal');
}

let addFurnPhotoDataUrl = null;
let deliverFurnPhotoDataUrl = null;

function handleFurnPhoto(prefix, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    if (prefix === 'addFurn') {
      addFurnPhotoDataUrl = e.target.result;
      document.getElementById('addFurnPhotoImg').src = addFurnPhotoDataUrl;
      document.getElementById('addFurnPhotoPreview').style.display = 'block';
    } else {
      deliverFurnPhotoDataUrl = e.target.result;
      document.getElementById('deliverFurnPhotoImg').src = deliverFurnPhotoDataUrl;
      document.getElementById('deliverFurnPhotoPreview').style.display = 'block';
    }
  };
  reader.readAsDataURL(file);
}

function clearFurnPhoto(prefix) {
  if (prefix === 'addFurn') {
    addFurnPhotoDataUrl = null;
    document.getElementById('addFurnPhotoInput').value = '';
    document.getElementById('addFurnPhotoPreview').style.display = 'none';
  } else {
    deliverFurnPhotoDataUrl = null;
    document.getElementById('deliverFurnPhotoInput').value = '';
    document.getElementById('deliverFurnPhotoPreview').style.display = 'none';
  }
}

async function addFurniture() {
  const btn = document.getElementById('addFurnBtn');
  btn.disabled = true; btn.textContent = 'Adding...';
  try {
    await api('POST', `/api/furniture/move/${currentMove.id}`, {
      name: document.getElementById('newFurnName').value,
      category: document.getElementById('newFurnCategory').value,
      condition_before: document.getElementById('newFurnCondition').value,
      damage_notes: document.getElementById('newFurnDamage').value,
      photo_url: addFurnPhotoDataUrl,
    });
    closeModal('addFurnModal');
    toast('Furniture item added!', 'success');
    addFurnPhotoDataUrl = null;
    loadFurniture();
  } catch(e) { toast(e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'Add Item';
}

function openFurnDelivery(id, name) {
  deliverFurnPhotoDataUrl = null;
  document.getElementById('deliverFurnId').value = id;
  document.getElementById('deliverFurnName').textContent = name;
  document.getElementById('deliverFurnNotes').value = '';
  document.getElementById('deliverFurnPhotoPreview').style.display = 'none';
  openModal('deliverFurnModal');
}

async function submitFurnDelivery() {
  if (!deliverFurnPhotoDataUrl) {
    toast('Delivery photo proof is required', 'error');
    return;
  }
  const btn = document.getElementById('deliverFurnBtn');
  btn.disabled = true; btn.textContent = 'Saving...';
  try {
    await api('PUT', `/api/furniture/${document.getElementById('deliverFurnId').value}/condition-after`, {
      condition_after: document.getElementById('deliverFurnCondition').value,
      damage_notes: document.getElementById('deliverFurnNotes').value,
      photo_url: deliverFurnPhotoDataUrl,
    });
    toast('Delivery logged ‚úì', 'success');
    closeModal('deliverFurnModal');
    deliverFurnPhotoDataUrl = null;
    loadFurniture();
  } catch(e) { toast(e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'Confirm Delivery';
}

// ‚îÄ‚îÄ‚îÄ QR SCAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STATUSES = ['packed','loaded','in_transit','delivered'];
let scanStream = null;
let scannedQR = null;
let selectedScanStatus = '';
let scanAnimFrame = null;
let scanPaused = false;

async function startCamera() {
  scannedQR = null;
  selectedScanStatus = '';
  scanPaused = false;
  document.getElementById('scanResult').style.display = 'none';
  document.getElementById('cameraError').style.display = 'none';
  stopCamera();

  // Always show our custom prompt first ‚Äî permission is only
  // requested when user explicitly taps the button (required by iOS Safari)
  document.getElementById('cameraPrompt').style.display = 'block';
  document.getElementById('scanArea').style.display = 'none';
  document.getElementById('scanPlaceholder').style.display = 'none';
  document.getElementById('scanResult').style.display = 'none';
}

async function requestCameraPermission() {
  const btn = document.getElementById('cameraPermBtn');
  btn.disabled = true;
  btn.textContent = 'Opening camera...';

  try {
    // Must be called directly inside a user gesture handler (button tap)
    // This is what triggers the native browser permission popup
    scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
    });

    // Permission granted ‚Äî show camera UI
    document.getElementById('cameraPrompt').style.display = 'none';
    document.getElementById('scanArea').style.display = 'block';
    document.getElementById('scanPlaceholder').style.display = 'block';
    document.getElementById('scanFrame').className = 'scan-frame';
    document.getElementById('scanStatus').textContent = 'Scanning...';

    const video = document.getElementById('scanVideo');
    video.srcObject = scanStream;
    video.setAttribute('playsinline', true);
    await video.play();
    scanAnimFrame = requestAnimationFrame(scanFrame);

  } catch(e) {
    btn.disabled = false;
    btn.textContent = 'Allow Camera Access';
    document.getElementById('cameraPrompt').style.display = 'none';
    document.getElementById('scanArea').style.display = 'none';
    document.getElementById('scanPlaceholder').style.display = 'block';
    document.getElementById('cameraError').style.display = 'block';
  }
}

function skipToManual() {
  document.getElementById('cameraPrompt').style.display = 'none';
  document.getElementById('scanArea').style.display = 'none';
  document.getElementById('scanPlaceholder').style.display = 'block';
}

function showCameraUI() {
  document.getElementById('cameraPrompt').style.display = 'none';
  document.getElementById('scanArea').style.display = 'block';
  document.getElementById('scanPlaceholder').style.display = 'block';
}

async function launchCamera() {
  stopCamera();
  try {
    scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    const video = document.getElementById('scanVideo');
    video.srcObject = scanStream;
    video.setAttribute('playsinline', true);
    video.play();
    video.addEventListener('loadedmetadata', () => {
      requestAnimationFrame(scanFrame);
    }, { once: true });
  } catch(e) {
    document.getElementById('cameraError').style.display = 'block';
    document.getElementById('scanArea').style.display = 'none';
  }
}

function scanFrame() {
  if (scanPaused) return;
  const video = document.getElementById('scanVideo');
  const canvas = document.getElementById('scanCanvas');
  if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) {
    scanAnimFrame = requestAnimationFrame(scanFrame);
    return;
  }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Only scan centre region for performance
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

  if (typeof jsQR !== 'undefined') {
    const code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: 'dontInvert'
    });
    if (code && code.data) {
      onQRDetected(code.data);
      return; // Stop loop until reset
    }
  }

  scanAnimFrame = requestAnimationFrame(scanFrame);
}

async function onQRDetected(rawData) {
  scanPaused = true;
  // Flash frame green
  document.getElementById('scanFrame').className = 'scan-frame detected';
  document.getElementById('scanStatus').textContent = '‚úì QR Detected!';

  // Haptic feedback on mobile
  if (navigator.vibrate) navigator.vibrate(80);

  // Extract UUID - the QR contains a full URL, get the last path segment
  const parts = rawData.split('/');
  const qrCode = parts[parts.length - 1];

  toast('QR detected ‚Äî looking up box...', '');

  try {
    const box = await api('GET', `/api/boxes/qr/${qrCode}`);
    scannedQR = box.qr_code;
    showScanResult(box);
  } catch(e) {
    // Maybe the raw data IS the UUID directly
    try {
      const box2 = await api('GET', `/api/boxes/qr/${rawData}`);
      scannedQR = box2.qr_code;
      showScanResult(box2);
    } catch(e2) {
      toast('Box not found for this QR', 'error');
      document.getElementById('scanFrame').className = 'scan-frame';
      document.getElementById('manualQR').value = qrCode;
      // Resume scanning
      scanPaused = false;
      scanAnimFrame = requestAnimationFrame(scanFrame);
    }
  }
}

function resetScanner() {
  scannedQR = null;
  selectedScanStatus = '';
  scanPaused = false;
  scanPhotoDataUrl = null;
  document.getElementById('scanResult').style.display = 'none';
  document.getElementById('scanFrame').className = 'scan-frame';
  document.getElementById('scanStatus').textContent = 'Scanning...';
  document.getElementById('scanLocation').value = '';
  document.getElementById('scanNotes').value = '';
  document.getElementById('manualQR').value = '';
  const photoInput = document.getElementById('scanPhoto');
  if (photoInput) photoInput.value = '';
  const photoPreview = document.getElementById('photoPreview');
  if (photoPreview) photoPreview.style.display = 'none';
  scanAnimFrame = requestAnimationFrame(scanFrame);
}

function retryCamera() {
  document.getElementById('cameraError').style.display = 'none';
  document.getElementById('cameraPrompt').style.display = 'block';
  const btn = document.getElementById('cameraPermBtn');
  btn.disabled = false;
  btn.textContent = 'Allow Camera Access';
}

function showCameraUI() {} // no longer needed, kept for safety
function launchCamera() {}  // no longer needed, kept for safety

function stopCamera() {
  if (scanAnimFrame) { cancelAnimationFrame(scanAnimFrame); scanAnimFrame = null; }
  if (scanStream) { scanStream.getTracks().forEach(t => t.stop()); scanStream = null; }
  const video = document.getElementById('scanVideo');
  if (video) video.srcObject = null;
}

async function lookupManualQR() {
  const qr = document.getElementById('manualQR').value.trim();
  if (!qr) return;
  try {
    const box = await api('GET', `/api/boxes/qr/${qr}`);
    scannedQR = box.qr_code;
    showScanResult(box);
  } catch(e) {
    toast('Box not found: ' + e.message, 'error');
  }
}

function showScanResult(box) {
  const catIcon = { kitchen:'üç≥', bedroom:'üõèÔ∏è', electronics:'üíª', fragile:'‚ö†Ô∏è', clothes:'üëï', books:'üìö', bathroom:'üöø', general:'üì¶' };
  document.getElementById('scannedBoxCard').innerHTML = `
    <div style="display:flex;align-items:center;gap:12px">
      <div style="font-size:32px">${catIcon[box.category]||'üì¶'}</div>
      <div>
        <div style="font-weight:700;font-size:16px">${box.label||'Unlabeled Box'}</div>
        <div style="margin-top:4px"><span class="badge badge-${box.status}">${box.status}</span></div>
      </div>
    </div>
    ${box.contents ? `<div style="font-size:13px;color:var(--sub);margin-top:8px">${box.contents}</div>` : ''}
    ${box.move_title ? `<div style="font-size:12px;color:var(--dim);margin-top:4px">Move: ${box.move_title}</div>` : ''}
  `;
  selectedScanStatus = '';
  // Auto-select next logical status
  const nextIdx = STATUSES.indexOf(box.status) + 1;
  if (nextIdx > 0 && nextIdx < STATUSES.length) selectedScanStatus = STATUSES[nextIdx];

  document.getElementById('statusChips').innerHTML = STATUSES.map(s => `
    <div class="chip ${s === selectedScanStatus ? 'sel' : ''}" onclick="selectStatus('${s}',this)">${s.replace('_',' ')}</div>
  `).join('');

  document.getElementById('scanPlaceholder').style.display = 'none';
  document.getElementById('scanResult').style.display = 'block';
}

function selectStatus(s, el) {
  selectedScanStatus = s;
  document.querySelectorAll('#statusChips .chip').forEach(c => c.classList.remove('sel'));
  el.classList.add('sel');
}

async function submitScan() {
  if (!scannedQR || !selectedScanStatus) { toast('Select a status first', 'error'); return; }
  const btn = document.getElementById('scanSubmitBtn');
  btn.disabled = true; btn.textContent = 'Logging...';
  try {
    await api('POST', `/api/boxes/scan/${scannedQR}`, {
      status: selectedScanStatus,
      location: document.getElementById('scanLocation').value,
      notes: document.getElementById('scanNotes').value,
      photo_url: scanPhotoDataUrl || null,
    });
    toast(`Box marked as ${selectedScanStatus.replace('_',' ')} ‚úì`, 'success');
    resetScanner();
  } catch(e) { toast(e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'Log Scan';
}

// ‚îÄ‚îÄ‚îÄ PAYMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const STATUS_LABELS = {
  'payment_pending':              { label: 'Payment Pending',       color: 'var(--warn)',    icon: 'üí≥' },
  'payment_under_verification':   { label: 'Under Verification',    color: '#a78bfa',        icon: 'üîç' },
  'active':                       { label: 'Active',                color: 'var(--success)', icon: '‚úÖ' },
  'in_progress':                  { label: 'In Progress',           color: 'var(--accent2)', icon: 'üöõ' },
  'completed':                    { label: 'Completed',             color: 'var(--success)', icon: 'üèÅ' },
  'closed':                       { label: 'Closed',                color: 'var(--dim)',     icon: 'üîí' },
};

const TIMELINE_STEPS = [
  { key: 'created',                       label: 'Move Created',             sub: 'Details entered' },
  { key: 'payment_pending',               label: 'Payment Pending',          sub: 'Complete payment to activate' },
  { key: 'payment_under_verification',    label: 'Payment Under Review',     sub: 'Admin verification in progress' },
  { key: 'active',                        label: 'Move Active',              sub: 'Agent assigned, features unlocked' },
  { key: 'in_progress',                   label: 'In Progress',              sub: 'Move execution underway' },
  { key: 'completed',                     label: 'Completed',                sub: 'All items delivered' },
  { key: 'closed',                        label: 'Closed',                   sub: 'Move report generated & closed' },
];

function isActive(move) {
  return ['active', 'in_progress', 'completed'].includes(move.status);
}

// ‚îÄ‚îÄ Legacy payment screen removed ‚Äî see updated openPaymentScreen / renderPaymentScreen below ‚îÄ‚îÄ



// Open pay-now modal
function openPayModal(moveId, amtDue) {
  document.getElementById('payModalTitle').textContent = `Pay ‚Çπ${parseFloat(amtDue).toFixed(2)}`;
  document.getElementById('payModalContent').innerHTML = `
    <div style="font-size:13px;color:var(--sub);margin-bottom:16px">Choose your preferred payment method:</div>
    <div class="pay-method-grid">
      <div class="pay-method-btn" onclick="selectPayMethod('upi',this)" id="pm-upi">
        <div class="pay-method-icon">üì≤</div><div class="pay-method-label">UPI</div>
      </div>
      <div class="pay-method-btn" onclick="selectPayMethod('card',this)" id="pm-card">
        <div class="pay-method-icon">üí≥</div><div class="pay-method-label">Card</div>
      </div>
      <div class="pay-method-btn" onclick="selectPayMethod('netbanking',this)" id="pm-netbanking">
        <div class="pay-method-icon">üè¶</div><div class="pay-method-label">Net Banking</div>
      </div>
      <div class="pay-method-btn" onclick="selectPayMethod('wallet',this)" id="pm-wallet">
        <div class="pay-method-icon">üëõ</div><div class="pay-method-label">Wallet</div>
      </div>
    </div>
    <div id="payMethodDetails" style="margin-bottom:16px"></div>
    <div style="font-size:11px;color:var(--dim);margin-bottom:16px;text-align:center">üîí Payments are processed securely. Test mode ‚Äî no real charge.</div>
    <button class="btn btn-primary" onclick="submitOnlinePayment('${moveId}',${amtDue})" id="payNowBtn" disabled>Pay ‚Çπ${parseFloat(amtDue).toFixed(2)}</button>
  `;
  window._payMethod = '';
  openModal('payModal');
}

let _payMethod = '';
function selectPayMethod(method, el) {
  _payMethod = method;
  document.querySelectorAll('.pay-method-btn').forEach(b => b.classList.remove('sel'));
  el.classList.add('sel');
  document.getElementById('payNowBtn').disabled = false;

  const details = document.getElementById('payMethodDetails');
  if (method === 'upi') {
    details.innerHTML = `<div class="field"><label>UPI ID</label><input type="text" id="upiId" class="upi-input" placeholder="yourname@upi" inputmode="email"/></div>`;
  } else if (method === 'card') {
    details.innerHTML = `
      <div class="field"><label>Card Number</label><input type="text" id="cardNum" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" maxlength="19"/></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="field"><label>Expiry</label><input type="text" id="cardExp" placeholder="MM/YY" maxlength="5"/></div>
        <div class="field"><label>CVV</label><input type="password" id="cardCvv" placeholder="‚Ä¢‚Ä¢‚Ä¢" maxlength="3" inputmode="numeric"/></div>
      </div>`;
  } else {
    details.innerHTML = `<div style="font-size:13px;color:var(--sub);padding:8px 0">You'll be redirected to complete payment via ${method}.</div>`;
  }
}

async function submitOnlinePayment(moveId, amount) {
  const btn = document.getElementById('payNowBtn');
  btn.disabled = true; btn.textContent = 'Processing...';
  try {
    const data = await api('POST', `/api/payments/move/${moveId}/online`, {
      payment_mode: _payMethod,
      amount: amount,
      transaction_id: `TXN_${Date.now()}`,
    });
    closeModal('payModal');
    toast(data.message, 'success');
    currentMove.status = data.move_status;
    await openPaymentScreen(moveId);
  } catch(e) {
    toast('Payment failed: ' + e.message, 'error');
    btn.disabled = false; btn.textContent = `Pay ‚Çπ${parseFloat(amount).toFixed(2)}`;
  }
}

function openCashModal(moveId) {
  window._cashMoveId = moveId;
  openModal('cashModal');
}

async function submitCashPayment() {
  const amount = document.getElementById('cashAmount').value;
  if (!amount || parseFloat(amount) <= 0) { toast('Enter a valid amount', 'error'); return; }
  const btn = document.getElementById('cashSubmitBtn');
  btn.disabled = true; btn.textContent = 'Submitting...';
  try {
    const data = await api('POST', `/api/payments/move/${window._cashMoveId}/cash`, {
      amount: parseFloat(amount),
      payment_mode: document.getElementById('cashMode').value,
      notes: document.getElementById('cashNotes').value,
    });
    closeModal('cashModal');
    toast(data.message, 'success');
    await openPaymentScreen(window._cashMoveId);
  } catch(e) {
    toast(e.message, 'error');
    btn.disabled = false; btn.textContent = 'Mark Payment Received';
  }
}

// Pricing setup for new moves without pricing
function openPricingSetup(moveId) {
  document.getElementById('payModalTitle').textContent = 'Set Move Pricing';
  document.getElementById('payModalContent').innerHTML = `
    <div style="font-size:13px;color:var(--sub);margin-bottom:16px">Enter move details to calculate your price:</div>
    <div class="field"><label>Base Price (‚Çπ)</label><input type="number" id="priceBase" placeholder="5000" inputmode="decimal"/></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="field"><label>Distance (km)</label><input type="number" id="priceKm" placeholder="0" inputmode="decimal"/></div>
      <div class="field"><label>No. of Rooms</label><input type="number" id="priceRooms" placeholder="2" inputmode="numeric"/></div>
    </div>
    <div class="field"><label>Floor Surcharge (‚Çπ)</label><input type="number" id="priceFloor" placeholder="0" inputmode="decimal"/></div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <input type="checkbox" id="priceFragile" style="width:18px;height:18px;accent-color:var(--accent)"/>
      <label for="priceFragile" style="font-size:14px">Has fragile items (+‚Çπ500)</label>
    </div>
    <div class="field"><label>Discount (‚Çπ)</label><input type="number" id="priceDiscount" placeholder="0" inputmode="decimal"/></div>
    <button class="btn btn-primary" onclick="calculateAndPay('${moveId}')">Calculate & Proceed to Pay</button>
  `;
  openModal('payModal');
}

async function calculateAndPay(moveId) {
  try {
    const data = await api('POST', `/api/payments/move/${moveId}/initiate`, {
      base_price: parseFloat(document.getElementById('priceBase').value) || 0,
      distance_km: parseFloat(document.getElementById('priceKm').value) || 0,
      num_rooms: parseInt(document.getElementById('priceRooms').value) || 0,
      floor_surcharge: parseFloat(document.getElementById('priceFloor').value) || 0,
      has_fragile: document.getElementById('priceFragile').checked,
      discount: parseFloat(document.getElementById('priceDiscount').value) || 0,
    });
    closeModal('payModal');
    toast(`Total: ‚Çπ${data.total.toFixed(2)} ‚Äî Invoice #${data.invoice_number}`, 'success');
    openPaymentScreen(moveId);
  } catch(e) { toast(e.message, 'error'); }
}

// Show payment gate popup when blocked action is attempted
function showPaymentGate(moveId) {
  document.getElementById('payModalTitle').textContent = 'üí≥ Payment Required';
  document.getElementById('payModalContent').innerHTML = `
    <div style="text-align:center;padding:16px 0">
      <div style="font-size:48px;margin-bottom:12px">üö´</div>
      <div style="font-size:16px;font-weight:700;margin-bottom:8px;color:var(--warn)">Move Not Active Yet</div>
      <div style="font-size:14px;color:var(--sub);line-height:1.7;margin-bottom:24px">Your move is pending activation. Please complete payment to access this feature.</div>
      <button class="btn btn-primary" onclick="closeModal('payModal');openPaymentScreen('${moveId}')" style="max-width:240px;margin:0 auto">üí≥ Complete Payment</button>
    </div>
  `;
  openModal('payModal');
}

async function generateReport(moveId) {
  const id = moveId || currentMove?.id;
  showScreen('report');
  setTopbar('report');
  const content = document.getElementById('reportContent');
  content.innerHTML = '<div style="text-align:center;padding:60px"><div class="spinner"></div><div style="margin-top:16px;color:var(--sub);font-size:13px">Generating PDF...</div></div>';
  try {
    const r = await fetch(`${BASE}/api/reports/generate/${id}`, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token },
    });
    if (r.ok) {
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `move-report-${id}.pdf`; a.click();
      content.innerHTML = `
        <div style="text-align:center;padding:40px">
          <div style="font-size:56px;margin-bottom:16px">‚úÖ</div>
          <div style="font-size:18px;font-weight:700;margin-bottom:8px">Report Downloaded!</div>
          <div style="color:var(--sub);font-size:13px;margin-bottom:24px">Check your Downloads folder</div>
          <button class="btn btn-primary" onclick="generateReport('${id}')">Download Again</button>
        </div>`;
    } else {
      throw new Error('Report generation failed');
    }
  } catch(e) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Failed</div><div class="empty-sub">${e.message}</div></div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYMENT FLOW  (6-step):
//  1. Admin sets confirmed price  ‚Üí customer notified
//  2. Customer pays 10% token     ‚Üí admin verifies
//  3. Token verified              ‚Üí move ACTIVE, agent assigned
//  4. Agent on-site               ‚Üí submits final quote
//  5. Customer pays balance       ‚Üí admin verifies
//  6. Balance verified            ‚Üí move IN_PROGRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function openPaymentScreen(moveId) {
  showScreen('payment');
  setTopbar('payment');
  const content = document.getElementById('paymentContent');
  content.innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
  try {
    const [data, quote] = await Promise.all([
      api('GET', `/api/payments/move/${moveId}`),
      api('GET', `/api/quotes/move/${moveId}`).catch(() => null),
    ]);
    currentMove = { ...(currentMove||{}), id: moveId, ...data };
    renderPaymentScreen(data, quote);
  } catch(e) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`;
  }
}

function renderPaymentScreen(data, quote) {
  const content = document.getElementById('paymentContent');
  const status       = data.move_status || '';
  const isPending    = ['payment_pending','created'].includes(status);
  const isVerifying  = status === 'payment_under_verification';
  const isActive     = ['active','in_progress','completed'].includes(status);
  const isCustomer   = user?.role === 'customer';
  const isAgent      = user?.role === 'agent';
  const isAdmin      = user?.role === 'admin';
  const amtTotal     = parseFloat(data.amount_total || 0);
  const amtPaid      = parseFloat(data.amount_paid  || 0);
  const tokenAmt     = data.token_amount ? parseFloat(data.token_amount) : Math.round(amtTotal * 0.10);
  const priceIsSet   = amtTotal > 0;

  // ‚îÄ‚îÄ Step indicator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const steps = [
    { key:'price_set',   label:'Price Set',       done: priceIsSet },
    { key:'token',       label:'Token Paid',       done: !!data.token_paid },
    { key:'active',      label:'Move Active',      done: isActive },
    { key:'quote',       label:'Final Quote',      done: !!quote },
    { key:'balance',     label:'Balance Paid',     done: status === 'in_progress' || status === 'completed' },
    { key:'inprogress',  label:'In Progress',      done: status === 'in_progress' || status === 'completed' },
  ];
  const stepHtml = `
  <div style="display:flex;gap:0;margin-bottom:24px;overflow-x:auto;padding-bottom:4px">
    ${steps.map((s,i) => `
    <div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:60px">
      <div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;
        background:${s.done?'var(--accent)':'#e2e8f0'};color:${s.done?'#fff':'#94a3b8'}">
        ${s.done?'‚úì':(i+1)}
      </div>
      ${i<steps.length-1?`<div style="position:relative;top:-14px;left:50%;width:100%;height:2px;background:${s.done?'var(--accent)':'#e2e8f0'};z-index:-1"></div>`:''}
      <div style="font-size:10px;color:${s.done?'var(--accent)':'#94a3b8'};margin-top:4px;text-align:center;font-weight:${s.done?'700':'400'}">${s.label}</div>
    </div>`).join('')}
  </div>`;

  // ‚îÄ‚îÄ Amount summary card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const quotedTotal = quote ? parseFloat(quote.total) : 0;
  const finalTotal  = quotedTotal || amtTotal;
  const balanceDue  = Math.max(0, finalTotal - amtPaid);

  const summaryHtml = `
  <div style="background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:14px;padding:18px;margin-bottom:16px">
    <div style="font-size:11px;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">üí∞ Payment Summary</div>
    ${priceIsSet ? `
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0">
      <span style="font-size:13px;color:var(--sub)">Confirmed Price</span>
      <span style="font-size:14px;font-weight:600">‚Çπ${amtTotal.toLocaleString('en-IN')}</span>
    </div>
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0">
      <span style="font-size:13px;color:var(--sub)">Token (10%)</span>
      <span style="font-size:14px;font-weight:600;color:var(--accent)">‚Çπ${tokenAmt.toLocaleString('en-IN')}</span>
    </div>` : `<div style="padding:12px 0;color:var(--sub);font-size:13px">‚è≥ Awaiting price confirmation from admin</div>`}
    ${quotedTotal > 0 ? `
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0">
      <span style="font-size:13px;color:var(--sub)">Agent's Final Price</span>
      <span style="font-size:14px;font-weight:600;color:#7c3aed">‚Çπ${quotedTotal.toLocaleString('en-IN')}</span>
    </div>` : ''}
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e2e8f0">
      <span style="font-size:13px;color:var(--sub)">Amount Paid</span>
      <span style="font-size:14px;font-weight:700;color:var(--success)">‚Çπ${amtPaid.toLocaleString('en-IN')}</span>
    </div>
    ${balanceDue > 0 ? `
    <div style="display:flex;justify-content:space-between;padding:10px 0">
      <span style="font-size:14px;font-weight:700">Balance Due</span>
      <span style="font-size:18px;font-weight:800;color:${status==='in_progress'||status==='completed'?'var(--success)':'var(--error)'}">‚Çπ${balanceDue.toLocaleString('en-IN')}</span>
    </div>` : `<div style="padding:8px 0;font-size:13px;color:var(--success);font-weight:600">‚úÖ Fully Paid</div>`}
  </div>`;

  // ‚îÄ‚îÄ Status banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const bannerCfg = {
    payment_pending:             { bg:'#fffbeb', border:'#fde68a', icon:'üí∞', color:'#b45309', msg: priceIsSet ? `Pay ‚Çπ${tokenAmt.toLocaleString('en-IN')} token to confirm your booking` : 'Admin will confirm your price shortly' },
    payment_under_verification:  { bg:'#eff6ff', border:'#bfdbfe', icon:'üîç', color:'#1d4ed8', msg:'Payment submitted ‚Äî admin is verifying' },
    active:                      { bg:'#f0fdf4', border:'#bbf7d0', icon:'‚úÖ', color:'#15803d', msg:'Move active! Agent will visit for final quote' },
    in_progress:                 { bg:'#f0fdf4', border:'#bbf7d0', icon:'üöõ', color:'#15803d', msg:'Move is in progress' },
    completed:                   { bg:'#ede9fe', border:'#ddd6fe', icon:'üéâ', color:'#6d28d9', msg:'Move completed!' },
  };
  const bc = bannerCfg[status] || { bg:'#f1f5f9', border:'#e2e8f0', icon:'üì¶', color:'var(--sub)', msg:status };
  const bannerHtml = `
  <div style="padding:14px 16px;border-radius:12px;margin-bottom:20px;display:flex;align-items:center;gap:12px;
    background:${bc.bg};border:1.5px solid ${bc.border}">
    <span style="font-size:26px;flex-shrink:0">${bc.icon}</span>
    <div>
      <div style="font-size:13px;font-weight:700;color:${bc.color}">${STATUS_LABELS[status]?.label || status}</div>
      <div style="font-size:12px;color:var(--sub);margin-top:2px">${bc.msg}</div>
    </div>
  </div>`;

  // ‚îÄ‚îÄ CTA section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let ctaHtml = '';

  // Customer: awaiting price
  if (isCustomer && isPending && !priceIsSet) {
    ctaHtml = `
    <div style="padding:16px;background:#fffbeb;border:1.5px solid #fde68a;border-radius:12px;text-align:center;margin-bottom:16px">
      <div style="font-size:32px;margin-bottom:8px">‚è≥</div>
      <div style="font-weight:700;margin-bottom:6px">Waiting for price confirmation</div>
      <div style="font-size:13px;color:var(--sub)">Our team will review your move details and confirm the price shortly. You'll get a notification.</div>
    </div>`;
  }

  // Customer: price set, can pay token
  if (isCustomer && isPending && priceIsSet) {
    ctaHtml = `
    <button onclick="openTokenPayModal('${data.move_id}',${tokenAmt})"
      style="width:100%;padding:16px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-family:inherit;font-size:16px;font-weight:800;cursor:pointer;margin-bottom:12px;box-shadow:0 4px 14px rgba(37,99,235,0.25)">
      üîê Pay ‚Çπ${tokenAmt.toLocaleString('en-IN')} to Confirm Booking ‚Üí
    </button>
    <div style="text-align:center;font-size:12px;color:var(--sub);margin-bottom:20px">
      This is 10% of your confirmed price. Pay via UPI or bank transfer and submit the reference.
    </div>`;
  }

  // Customer: token under verification
  if (isCustomer && isVerifying && !data.token_paid) {
    ctaHtml = `
    <div style="padding:14px;background:#eff6ff;border:1.5px solid #bfdbfe;border-radius:12px;font-size:13px;color:#1d4ed8;text-align:center;margin-bottom:16px">
      üîç Token payment submitted and under review. You'll be notified within 2‚Äì4 hours.
    </div>`;
  }

  // Customer: active + quote exists ‚Üí show balance CTA
  if (isCustomer && isActive && quote && balanceDue > 0 && status !== 'in_progress' && status !== 'completed') {
    ctaHtml = `
    <button onclick="openBalancePayModal('${data.move_id}',${balanceDue})"
      style="width:100%;padding:16px;background:#7c3aed;border:none;border-radius:14px;color:#fff;font-family:inherit;font-size:16px;font-weight:800;cursor:pointer;margin-bottom:12px;box-shadow:0 4px 14px rgba(124,58,237,0.25)">
      üí≥ Pay Balance ‚Çπ${balanceDue.toLocaleString('en-IN')} ‚Üí
    </button>`;
  }

  // Customer: balance under verification
  if (isCustomer && isVerifying && data.token_paid) {
    ctaHtml = `
    <div style="padding:14px;background:#eff6ff;border:1.5px solid #bfdbfe;border-radius:12px;font-size:13px;color:#1d4ed8;text-align:center;margin-bottom:16px">
      üîç Balance payment submitted and under review. You'll be notified once verified.
    </div>`;
  }

  // Agent/Admin: set price (when no price yet)
  if ((isAgent || isAdmin) && !priceIsSet) {
    ctaHtml += `
    <div style="background:#eff6ff;border:1.5px solid #bfdbfe;border-radius:14px;padding:16px;margin-bottom:16px">
      <div style="font-size:13px;font-weight:700;color:var(--accent);margin-bottom:4px">üí∞ Set Confirmed Price</div>
      <div style="font-size:12px;color:var(--sub);margin-bottom:12px">Set the final price so the customer can pay the 10% token to confirm their booking.</div>
      <button onclick="openSetPricingModal('${data.move_id}')" style="padding:11px 20px;background:var(--accent);border:none;border-radius:10px;color:#fff;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">
        üìù Set Price
      </button>
    </div>`;
  }

  // Agent/Admin: move active, no quote yet ‚Üí submit on-site quote
  if ((isAgent || isAdmin) && isActive && !quote) {
    ctaHtml += `
    <div style="background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:14px;padding:16px;margin-bottom:16px">
      <div style="font-size:13px;font-weight:700;color:#15803d;margin-bottom:4px">üìã Submit On-Site Quote</div>
      <div style="font-size:12px;color:var(--sub);margin-bottom:12px">After visiting the customer's location, submit your final estimate. The balance will be auto-calculated.</div>
      <button onclick="openSubmitQuoteModal('${data.move_id}')" style="padding:11px 20px;background:#16a34a;border:none;border-radius:10px;color:#fff;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">
        üìù Submit Final Quote
      </button>
    </div>`;
  }

  // ‚îÄ‚îÄ Agent Quote detail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const quoteHtml = quote ? `
  <div style="background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:14px;padding:18px;margin-bottom:16px">
    <div style="font-size:11px;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">
      üìã Agent's Final Quote ${quote.agent_name ? `¬∑ ${quote.agent_name}` : ''}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
      <div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px">
        <div style="font-size:10px;color:var(--sub);margin-bottom:2px">Base Price</div>
        <div style="font-size:15px;font-weight:700">‚Çπ${parseFloat(quote.base_price).toLocaleString('en-IN')}</div>
      </div>
      ${parseFloat(quote.floor_charge)>0?`<div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px"><div style="font-size:10px;color:var(--sub);margin-bottom:2px">Floor Charges</div><div style="font-size:15px;font-weight:700">‚Çπ${parseFloat(quote.floor_charge).toLocaleString('en-IN')}</div></div>`:''}
      ${parseFloat(quote.fragile_charge)>0?`<div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px"><div style="font-size:10px;color:var(--sub);margin-bottom:2px">Fragile</div><div style="font-size:15px;font-weight:700">‚Çπ${parseFloat(quote.fragile_charge).toLocaleString('en-IN')}</div></div>`:''}
      ${parseFloat(quote.extra_items)>0?`<div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px"><div style="font-size:10px;color:#b45309;margin-bottom:2px">Extra Items</div><div style="font-size:15px;font-weight:700;color:#b45309">‚Çπ${parseFloat(quote.extra_items).toLocaleString('en-IN')}</div></div>`:''}
      ${parseFloat(quote.discount)>0?`<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px"><div style="font-size:10px;color:#16a34a;margin-bottom:2px">Discount</div><div style="font-size:15px;font-weight:700;color:#16a34a">‚àí‚Çπ${parseFloat(quote.discount).toLocaleString('en-IN')}</div></div>`:''}
      <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px">
        <div style="font-size:10px;color:var(--accent);margin-bottom:2px">GST 18%</div>
        <div style="font-size:15px;font-weight:700;color:var(--accent)">‚Çπ${parseFloat(quote.tax).toLocaleString('en-IN')}</div>
      </div>
    </div>
    <div style="border-top:2px solid #e2e8f0;padding-top:12px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:13px;color:var(--sub);font-weight:600">FINAL TOTAL</span>
      <span style="font-size:22px;font-weight:800;color:#7c3aed">‚Çπ${parseFloat(quote.total).toLocaleString('en-IN')}</span>
    </div>
    ${quote.notes?`<div style="margin-top:10px;padding:10px;background:#f1f5f9;border-radius:8px;font-size:13px;color:var(--sub)">üí¨ ${quote.notes}</div>`:''}
  </div>` : '';

  // ‚îÄ‚îÄ Payment history ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const historyHtml = data.payments && data.payments.length ? `
  <div style="background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:14px;padding:18px">
    <div style="font-size:11px;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">üßæ Payment History</div>
    ${data.payments.map(p => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #e2e8f0">
      <div>
        <div style="font-size:13px;font-weight:600;text-transform:capitalize">${(p.payment_type||'payment').replace('_',' ')} ¬∑ ${(p.payment_mode||'').replace('_',' ')}</div>
        <div style="font-size:11px;color:var(--sub)">${new Date(p.created_at).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:14px;font-weight:700">‚Çπ${parseFloat(p.amount).toLocaleString('en-IN')}</div>
        <div style="font-size:11px;padding:2px 8px;border-radius:20px;display:inline-block;margin-top:2px;
          background:${['verified','success'].includes(p.status)?'#dcfce7':p.status==='under_verification'?'#eff6ff':'#fef2f2'};
          color:${['verified','success'].includes(p.status)?'#15803d':p.status==='under_verification'?'#1d4ed8':'#dc2626'}">
          ${p.status==='under_verification'?'Pending Verification':p.status}
        </div>
      </div>
    </div>`).join('')}
  </div>` : '';

  content.innerHTML = `
  <div style="max-width:560px;margin:0 auto">
    <div style="margin-bottom:20px">
      <div style="font-size:18px;font-weight:800;margin-bottom:4px">${data.title || 'Payment'}</div>
      <div style="font-size:12px;color:var(--sub)">${data.invoice_number ? `Invoice #${data.invoice_number}` : 'Invoice pending'}</div>
    </div>
    ${stepHtml}
    ${bannerHtml}
    ${summaryHtml}
    ${ctaHtml}
    ${quoteHtml}
    ${historyHtml}
  </div>`;
}

// ‚îÄ‚îÄ MODAL: Admin/Agent sets confirmed price ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSetPricingModal(moveId) {
  document.getElementById('setPricingContent').innerHTML = `
  <div style="font-size:13px;color:var(--sub);margin-bottom:16px">Set the confirmed price. Customer will be notified and asked to pay 10% token.</div>
  <div class="field"><label>Base Price (‚Çπ) *</label><input type="number" id="spBase" placeholder="e.g. 7999" min="0"/></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="field"><label>Floor Charges (‚Çπ)</label><input type="number" id="spFloor" value="0" min="0"/></div>
    <div class="field"><label>Fragile Handling (‚Çπ)</label><input type="number" id="spFragile" value="0" min="0"/></div>
    <div class="field"><label>Discount (‚Çπ)</label><input type="number" id="spDiscount" value="0" min="0"/></div>
    <div class="field"><label>Notes</label><input type="text" id="spNotes" placeholder="Optional"/></div>
  </div>
  <div id="spPreview" style="display:none;background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:14px;margin:12px 0;text-align:center">
    <div style="font-size:11px;color:var(--sub);margin-bottom:4px">TOTAL (incl. GST 18%)</div>
    <div id="spTotal" style="font-size:28px;font-weight:800;color:var(--accent)">‚Äî</div>
    <div id="spToken" style="font-size:13px;color:var(--sub);margin-top:4px">Token: ‚Äî</div>
  </div>
  <button onclick="previewSetPrice()" style="width:100%;padding:10px;background:#f1f5f9;border:1.5px solid #e2e8f0;border-radius:10px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;margin-bottom:10px">üî¢ Preview Total</button>
  <button onclick="submitSetPricing('${moveId}')" id="spBtn" class="btn btn-primary">Confirm Price & Notify Customer</button>`;
  openModal('setPricingModal');
}

function previewSetPrice() {
  const base     = parseFloat(document.getElementById('spBase').value) || 0;
  const floor    = parseFloat(document.getElementById('spFloor').value) || 0;
  const fragile  = parseFloat(document.getElementById('spFragile').value) || 0;
  const discount = parseFloat(document.getElementById('spDiscount').value) || 0;
  const subtotal = base + floor + fragile - discount;
  const total    = subtotal + Math.round(subtotal * 0.18);
  const token    = Math.round(total * 0.10);
  document.getElementById('spPreview').style.display = 'block';
  document.getElementById('spTotal').textContent  = `‚Çπ${total.toLocaleString('en-IN')}`;
  document.getElementById('spToken').textContent  = `Token (10%): ‚Çπ${token.toLocaleString('en-IN')}`;
}

async function submitSetPricing(moveId) {
  const base = parseFloat(document.getElementById('spBase').value);
  if (!base || base <= 0) { toast('Base price required', 'error'); return; }
  const btn = document.getElementById('spBtn');
  btn.disabled = true; btn.textContent = 'Saving...';
  try {
    const d = await api('POST', `/api/payments/move/${moveId}/set-pricing`, {
      base_price:       base,
      floor_surcharge:  parseFloat(document.getElementById('spFloor').value)   || 0,
      fragile_surcharge:parseFloat(document.getElementById('spFragile').value) || 0,
      discount:         parseFloat(document.getElementById('spDiscount').value)|| 0,
      notes:            document.getElementById('spNotes').value || null,
    });
    closeModal('setPricingModal');
    toast(`‚úÖ Price set ‚Çπ${d.total.toLocaleString('en-IN')} ¬∑ Token: ‚Çπ${d.token_amount.toLocaleString('en-IN')}`, 'success');
    openPaymentScreen(moveId);
  } catch(e) {
    toast(e.message, 'error');
    btn.disabled = false; btn.textContent = 'Confirm Price & Notify Customer';
  }
}

// ‚îÄ‚îÄ MODAL: Customer pays 10% token ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTokenPayModal(moveId, amount) {
  document.getElementById('tokenPayContent').innerHTML = `
  <div style="text-align:center;margin-bottom:20px">
    <div style="font-size:40px;margin-bottom:8px">üîê</div>
    <div style="font-size:18px;font-weight:800;margin-bottom:4px">Confirm Your Booking</div>
    <div style="font-size:13px;color:var(--sub)">Pay 10% now to activate your move</div>
  </div>
  <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:16px;text-align:center;margin-bottom:20px">
    <div style="font-size:11px;color:var(--sub);margin-bottom:4px">TOKEN AMOUNT</div>
    <div style="font-size:36px;font-weight:800;color:var(--accent)">‚Çπ${parseFloat(amount).toLocaleString('en-IN')}</div>
    <div style="font-size:12px;color:var(--sub);margin-top:4px">10% of total ¬∑ Balance payable after agent visit</div>
  </div>
  <div class="field"><label>Payment Mode</label>
    <select id="tpMode" style="width:100%;padding:11px 14px;border:1.5px solid #e2e8f0;border-radius:10px;font-family:inherit;font-size:14px">
      <option value="upi">UPI</option>
      <option value="bank_transfer">Bank Transfer / NEFT</option>
      <option value="cash">Cash to Agent</option>
    </select>
  </div>
  <div class="field"><label>Transaction Ref / UTR Number</label>
    <input type="text" id="tpRef" placeholder="e.g. 4038291829 or UTR123456"/></div>
  <div class="field"><label>Notes (optional)</label>
    <input type="text" id="tpNotes" placeholder="Any message for admin"/></div>
  <button onclick="submitTokenPay('${moveId}')" id="tpBtn" class="btn btn-primary">
    Submit Token Payment ‚Çπ${parseFloat(amount).toLocaleString('en-IN')}
  </button>`;
  openModal('tokenPayModal');
}

async function submitTokenPay(moveId) {
  const btn = document.getElementById('tpBtn');
  btn.disabled = true; btn.textContent = 'Submitting...';
  try {
    const d = await api('POST', `/api/payments/move/${moveId}/token`, {
      payment_mode:    document.getElementById('tpMode').value,
      transaction_ref: document.getElementById('tpRef').value || null,
      notes:           document.getElementById('tpNotes').value || null,
    });
    closeModal('tokenPayModal');
    toast(d.message, 'success');
    openPaymentScreen(moveId);
  } catch(e) {
    toast(e.message, 'error');
    btn.disabled = false; btn.textContent = 'Submit Token Payment';
  }
}

// ‚îÄ‚îÄ MODAL: Customer pays balance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openBalancePayModal(moveId, amount) {
  document.getElementById('balPayContent').innerHTML = `
  <div style="text-align:center;margin-bottom:20px">
    <div style="font-size:40px;margin-bottom:8px">üí≥</div>
    <div style="font-size:18px;font-weight:800;margin-bottom:4px">Pay Remaining Balance</div>
    <div style="font-size:13px;color:var(--sub)">Complete payment to start your move</div>
  </div>
  <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:16px;text-align:center;margin-bottom:20px">
    <div style="font-size:11px;color:var(--sub);margin-bottom:4px">BALANCE DUE</div>
    <div style="font-size:36px;font-weight:800;color:#15803d">‚Çπ${parseFloat(amount).toLocaleString('en-IN')}</div>
  </div>
  <div class="field"><label>Payment Mode</label>
    <select id="bpMode" style="width:100%;padding:11px 14px;border:1.5px solid #e2e8f0;border-radius:10px;font-family:inherit;font-size:14px">
      <option value="upi">UPI</option>
      <option value="bank_transfer">Bank Transfer / NEFT</option>
      <option value="cash">Cash to Agent</option>
    </select>
  </div>
  <div class="field"><label>Transaction Ref / UTR Number</label>
    <input type="text" id="bpRef" placeholder="e.g. 4038291829 or UTR123456"/></div>
  <button onclick="submitBalancePay('${moveId}')" id="bpBtn" class="btn btn-primary">
    Submit Balance Payment ‚Çπ${parseFloat(amount).toLocaleString('en-IN')}
  </button>`;
  openModal('balPayModal');
}

async function submitBalancePay(moveId) {
  const btn = document.getElementById('bpBtn');
  btn.disabled = true; btn.textContent = 'Submitting...';
  try {
    const d = await api('POST', `/api/payments/move/${moveId}/pay-balance`, {
      payment_mode:    document.getElementById('bpMode').value,
      transaction_ref: document.getElementById('bpRef').value || null,
    });
    closeModal('balPayModal');
    toast(d.message, 'success');
    openPaymentScreen(moveId);
  } catch(e) {
    toast(e.message, 'error');
    btn.disabled = false; btn.textContent = 'Submit Balance Payment';
  }
}

// ‚îÄ‚îÄ MODAL: Agent submits on-site quote ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSubmitQuoteModal(moveId) {
  document.getElementById('submitQuoteContent').innerHTML = `
  <div style="font-size:13px;color:var(--sub);margin-bottom:16px">Submit your on-site final quote. The customer's balance will be auto-updated.</div>
  <div class="field"><label>Base Price (‚Çπ) *</label><input type="number" id="sqBase" placeholder="e.g. 8500" min="0"/></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="field"><label>Floor Charges (‚Çπ)</label><input type="number" id="sqFloor" value="0" min="0"/></div>
    <div class="field"><label>Fragile Handling (‚Çπ)</label><input type="number" id="sqFragile" value="0" min="0"/></div>
    <div class="field"><label>Extra Items (‚Çπ)</label><input type="number" id="sqExtra" value="0" min="0"/></div>
    <div class="field"><label>Discount (‚Çπ)</label><input type="number" id="sqDiscount" value="0" min="0"/></div>
  </div>
  <div class="field"><label>Notes to Customer</label><textarea id="sqNotes" placeholder="e.g. Found 2 extra heavy items on-site..." style="height:80px"></textarea></div>
  <div id="sqPreview" style="display:none;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:14px;margin:12px 0;text-align:center">
    <div style="font-size:11px;color:var(--sub);margin-bottom:4px">FINAL TOTAL (incl. GST)</div>
    <div id="sqTotal" style="font-size:28px;font-weight:800;color:#15803d">‚Äî</div>
  </div>
  <button onclick="previewQuote()" style="width:100%;padding:10px;background:#f1f5f9;border:1.5px solid #e2e8f0;border-radius:10px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;margin-bottom:10px">üî¢ Preview Total</button>
  <button onclick="submitAgentQuote('${moveId}')" id="sqBtn" class="btn btn-primary" style="background:#16a34a;border-color:#16a34a">Submit Quote to Customer</button>`;
  openModal('submitQuoteModal');
}

function previewQuote() {
  const base     = parseFloat(document.getElementById('sqBase').value) || 0;
  const floor    = parseFloat(document.getElementById('sqFloor').value) || 0;
  const fragile  = parseFloat(document.getElementById('sqFragile').value) || 0;
  const extra    = parseFloat(document.getElementById('sqExtra').value) || 0;
  const discount = parseFloat(document.getElementById('sqDiscount').value) || 0;
  const subtotal = base + floor + fragile + extra - discount;
  const total    = subtotal + Math.round(subtotal * 0.18);
  document.getElementById('sqPreview').style.display = 'block';
  document.getElementById('sqTotal').textContent = `‚Çπ${total.toLocaleString('en-IN')}`;
}

async function submitAgentQuote(moveId) {
  const base = parseFloat(document.getElementById('sqBase').value);
  if (!base || base <= 0) { toast('Base price is required', 'error'); return; }
  const btn = document.getElementById('sqBtn');
  btn.disabled = true; btn.textContent = 'Submitting...';
  try {
    const d = await api('POST', `/api/quotes/move/${moveId}`, {
      base_price:     base,
      floor_charge:   parseFloat(document.getElementById('sqFloor').value)   || 0,
      fragile_charge: parseFloat(document.getElementById('sqFragile').value) || 0,
      extra_items:    parseFloat(document.getElementById('sqExtra').value)   || 0,
      discount:       parseFloat(document.getElementById('sqDiscount').value)|| 0,
      notes:          document.getElementById('sqNotes').value || null,
    });
    closeModal('submitQuoteModal');
    toast(`‚úÖ Quote submitted! Final: ‚Çπ${d.total.toLocaleString('en-IN')} ¬∑ Balance due: ‚Çπ${d.balance_due.toLocaleString('en-IN')}`, 'success');
    openPaymentScreen(moveId);
  } catch(e) {
    toast(e.message, 'error');
    btn.disabled = false; btn.textContent = 'Submit Quote to Customer';
  }
}

// ‚îÄ‚îÄ Admin: verify token from admin payments panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function adminVerifyToken(moveId, action) {
  const sel = document.getElementById(`tokenAgent_${moveId}`);
  const agentId = sel ? sel.value || null : null;
  try {
    await api('POST', `/api/payments/move/${moveId}/verify-token`, { action, agent_id: agentId });
    toast(action === 'approve' ? '‚úÖ Move activated!' : '‚ùå Payment rejected', action === 'approve' ? 'success' : 'error');
    renderAdminPayments();
  } catch(e) { toast(e.message, 'error'); }
}

// ‚îÄ‚îÄ Admin: verify balance from admin payments panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function adminVerifyBalance(moveId, action) {
  try {
    await api('POST', `/api/payments/move/${moveId}/verify-balance`, { action });
    toast(action === 'approve' ? '‚úÖ Balance verified ‚Äî move in progress!' : '‚ùå Balance rejected', action === 'approve' ? 'success' : 'error');
    renderAdminPayments();
  } catch(e) { toast(e.message, 'error'); }
}


// ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow = '';
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = '', 3000);
}
// ‚îÄ‚îÄ‚îÄ ADMIN DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let adminTab = 'overview';
let adminData = {};

function openAdminDashboard() {
  showScreen('admin');
  setTopbar('admin');
  switchAdminTab('overview');
}

function switchAdminTab(tab) {
  adminTab = tab;
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  const btn = document.getElementById('atab-' + tab);
  if (btn) btn.classList.add('active');
  document.getElementById('adminContent').innerHTML =
    '<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';
  ({ overview: renderAdminOverview, moves: renderAdminMoves,
     payments: renderAdminPayments, users: renderAdminUsers,
     flags: renderAdminFlags }[tab] || (() => {}))();
}

async function renderAdminOverview() {
  const c = document.getElementById('adminContent');
  try {
    const [stats, pending] = await Promise.all([
      api('GET', '/api/admin/stats'),
      api('GET', '/api/admin/payments/pending'),
    ]);
    adminData.stats = stats; adminData.pending = pending;
    c.innerHTML = `
      <!-- KPI Row like admin.html -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px">
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px">
          <div style="font-size:11px;color:var(--sub);font-weight:600;letter-spacing:0.5px;margin-bottom:8px">TOTAL MOVES</div>
          <div style="font-size:32px;font-weight:800;color:var(--text);line-height:1">${stats.moves.total}</div>
          <div style="font-size:11px;color:var(--success);margin-top:4px">+${parseInt(stats.moves.active)+parseInt(stats.moves.in_progress)} active</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px">
          <div style="font-size:11px;color:var(--sub);font-weight:600;letter-spacing:0.5px;margin-bottom:8px">PAYMENT PENDING</div>
          <div style="font-size:32px;font-weight:800;color:var(--warn);line-height:1">${stats.moves.unpaid}</div>
          <div style="font-size:11px;color:var(--sub);margin-top:4px">${stats.pending_verifications} verifying</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px">
          <div style="font-size:11px;color:var(--sub);font-weight:600;letter-spacing:0.5px;margin-bottom:8px">REVENUE COLLECTED</div>
          <div style="font-size:32px;font-weight:800;color:var(--accent);line-height:1">‚Çπ${parseFloat(stats.revenue?.collected || 0).toLocaleString('en-IN')}</div>
          <div style="font-size:11px;color:var(--sub);margin-top:4px">${stats.users.customers} customers</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px">
          <div style="font-size:11px;color:var(--sub);font-weight:600;letter-spacing:0.5px;margin-bottom:8px">FIELD AGENTS</div>
          <div style="font-size:32px;font-weight:800;color:var(--success);line-height:1">${stats.users.agents}</div>
          <div style="font-size:11px;color:var(--sub);margin-top:4px">${parseInt(stats.users.total)} total users</div>
        </div>
      </div>
      ${pending.length ? `
      <div style="font-size:11px;font-weight:700;color:var(--sub);letter-spacing:0.8px;margin-bottom:12px">‚ö° NEEDS ATTENTION (${pending.length})</div>
      <div class="card" style="padding:0">
        ${pending.map(p => `
        <div style="padding:14px;border-bottom:1px solid var(--border)">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div><div style="font-weight:600;font-size:14px">${p.move_title}</div>
            <div style="font-size:12px;color:var(--sub)">üë§ ${p.customer_name} ¬∑ ${p.payment_mode}</div></div>
            <div style="text-align:right"><div style="font-weight:700;color:var(--accent)">‚Çπ${parseFloat(p.amount).toLocaleString('en-IN')}</div>
            <div style="font-size:11px;color:var(--dim)">${new Date(p.created_at).toLocaleDateString('en-IN')}</div></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button onclick="adminVerifyPayment('${p.id}','approve')" style="flex:1;padding:9px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);border-radius:8px;color:var(--success);font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">‚úì Approve</button>
            <button onclick="adminVerifyPayment('${p.id}','reject')" style="flex:1;padding:9px;background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);border-radius:8px;color:var(--error);font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">‚úó Reject</button>
          </div>
        </div>`).join('')}
      </div>` : `
      <div class="card" style="text-align:center;padding:20px">
        <div style="font-size:28px;margin-bottom:6px">‚úÖ</div>
        <div style="font-size:13px;color:var(--sub)">No pending verifications</div>
      </div>`}
    `;
  } catch(e) { c.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`; }
}

async function renderAdminMoves() {
  const c = document.getElementById('adminContent');
  try {
    const [moves, users] = await Promise.all([api('GET','/api/admin/moves'), api('GET','/api/admin/users')]);
    adminData.moves = moves;
    adminData.agents = users.filter(u => u.role === 'agent');
    c.innerHTML = `
      <div style="margin-bottom:12px;display:flex;gap:8px">
        <input type="text" id="moveSearchInput" placeholder="Search moves‚Ä¶" oninput="filterAdminMoves()"
          style="flex:1;background:var(--card2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;font-family:inherit;font-size:14px;outline:none"/>
        <select id="moveStatusFilter" onchange="filterAdminMoves()"
          style="background:var(--card2);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px;font-family:inherit;font-size:12px;outline:none">
          <option value="">All</option>
          <option value="payment_pending">Pending Payment</option>
          <option value="payment_under_verification">Verifying</option>
          <option value="active">Active</option>
          <option value="in_progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>
      </div>
      <div id="adminMovesList"></div>`;
    filterAdminMoves();
  } catch(e) { c.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`; }
}

function filterAdminMoves() {
  const q = (document.getElementById('moveSearchInput')?.value || '').toLowerCase();
  const filter = document.getElementById('moveStatusFilter')?.value || '';
  const moves = (adminData.moves || []).filter(m =>
    (!q || m.title.toLowerCase().includes(q) || (m.customer_name||'').toLowerCase().includes(q)) &&
    (!filter || m.status === filter)
  );
  const list = document.getElementById('adminMovesList');
  if (!list) return;
  if (!moves.length) { list.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">No matches</div></div>'; return; }
  list.innerHTML = moves.map(m => {
    const s = STATUS_LABELS[m.status] || { label: m.status, color: 'var(--sub)', icon: 'üì¶' };
    const agentOpts = (adminData.agents||[]).map(a =>
      `<option value="${a.id}" ${m.agent_id===a.id?'selected':''}>${a.name}</option>`).join('');
    const canForce = ['payment_pending','payment_under_verification','created'].includes(m.status);
    return `
    <div class="card" style="margin-bottom:10px;padding:14px">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <div><div style="font-weight:700">${m.title}</div>
        <div style="font-size:12px;color:var(--sub)">üë§ ${m.customer_name||'‚Äî'} ¬∑ ${m.customer_email||''}</div></div>
        <span style="font-size:20px">${s.icon}</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:10px">
        <span style="color:${s.color};font-weight:600">${s.label}</span>
        <span style="color:var(--dim)">üì¶ ${m.total_boxes} ¬∑ ‚Çπ${parseFloat(m.amount_collected||0).toLocaleString('en-IN')}</span>
      </div>
      <div style="display:flex;gap:8px">
        <select id="agsel-${m.id}" style="flex:1;background:var(--card2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:8px;font-family:inherit;font-size:12px;outline:none">
          <option value="">‚Äî Assign Agent ‚Äî</option>${agentOpts}
        </select>
        <button onclick="doAssignAgent('${m.id}')" style="padding:8px 12px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer">Assign</button>
        ${canForce?`<button onclick="doForceActivate('${m.id}')" style="padding:8px 10px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);border-radius:8px;color:var(--success);font-family:inherit;font-size:11px;font-weight:700;cursor:pointer">‚ö° Force</button>`:''}
      </div>
      ${['created','payment_pending'].includes(m.status) ? `
      <div style="margin-top:8px">
        <button onclick="openSetPricingModal('${m.id}')" style="width:100%;padding:9px;background:#eff6ff;border:1.5px solid #bfdbfe;border-radius:8px;color:var(--accent);font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">
          üí∞ ${m.amount_total > 0 ? 'Update' : 'Set'} Price${m.amount_total > 0 ? ` (‚Çπ${parseFloat(m.amount_total).toLocaleString('en-IN')} set)` : ''}
        </button>
      </div>` : ''}
    </div>`;
  }).join('');
}

async function doAssignAgent(moveId) {
  const agentId = document.getElementById('agsel-'+moveId)?.value;
  if (!agentId) { toast('Select an agent first', 'error'); return; }
  try {
    const data = await api('PUT', `/api/admin/moves/${moveId}/assign-agent`, { agent_id: agentId });
    const agentName = data?.agent?.name || data?.agent_name || 'Agent';
    toast(`Agent "${agentName}" assigned ‚úì`, 'success');
    showScreen('admin');
    setTopbar('admin');
    renderAdminMoves();
  } catch(e) { toast(e.message, 'error'); }
}

async function doForceActivate(moveId) {
  if (!confirm('Force-activate this move without payment verification?')) return;
  try {
    await api('POST', `/api/admin/moves/${moveId}/force-activate`);
    toast('Move force-activated ‚úì', 'success');
    showScreen('admin');
    setTopbar('admin');
    renderAdminMoves();
  } catch(e) { toast(e.message, 'error'); }
}

async function renderAdminPayments() {
  const c = document.getElementById('adminContent');
  try {
    const [pending, all, users] = await Promise.all([
      api('GET','/api/admin/payments/pending'),
      api('GET','/api/admin/payments'),
      adminData.users ? Promise.resolve(adminData.users) : api('GET','/api/admin/users'),
    ]);
    if (!adminData.users) adminData.users = users;
    adminData.agents = (adminData.users||[]).filter(u => u.role === 'agent');
    const statusColor = { success:'var(--success)', under_verification:'#a78bfa', failed:'var(--error)', pending:'var(--warn)' };
    c.innerHTML = `
      ${pending.length ? `
      <div style="font-size:11px;font-weight:700;color:var(--sub);letter-spacing:0.8px;margin-bottom:12px">‚ö° PENDING VERIFICATION (${pending.length})</div>
      <div class="card" style="padding:0;margin-bottom:16px">
        ${pending.map(p => {
          const isToken   = p.payment_type === 'token';
          const isBalance = p.payment_type === 'balance';
          const agentOpts = (adminData.agents||[]).map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
          const typeLabel = isToken ? 'üîê Token (10%)' : isBalance ? 'üí≥ Balance' : 'üí∞ Payment';
          return `
          <div style="padding:14px;border-bottom:1px solid var(--border)">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
              <div style="flex:1;min-width:0">
                <div style="font-weight:700;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.move_title}</div>
                <div style="font-size:12px;color:var(--sub);margin-top:2px">üë§ ${p.customer_name} ¬∑ ${typeLabel} ¬∑ ${p.payment_mode.replace('_',' ')}</div>
                ${p.transaction_id ? `<div style="font-size:11px;color:var(--dim);margin-top:2px">Ref: ${p.transaction_id}</div>` : ''}
                ${p.notes ? `<div style="font-size:11px;color:var(--dim);margin-top:2px">Note: ${p.notes}</div>` : ''}
              </div>
              <div style="text-align:right;flex-shrink:0">
                <div style="font-weight:800;font-size:18px;color:var(--accent)">‚Çπ${parseFloat(p.amount).toLocaleString('en-IN')}</div>
                <div style="font-size:11px;color:var(--dim)">${new Date(p.created_at).toLocaleDateString('en-IN',{day:'numeric',month:'short'})}</div>
              </div>
            </div>
            ${isToken ? `
            <div style="margin:10px 0 6px">
              <label style="font-size:11px;color:var(--sub);font-weight:600;display:block;margin-bottom:4px">Assign Agent (optional ‚Äî can be done later)</label>
              <select id="tokenAgent_${p.move_id}" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:8px;font-family:inherit;font-size:13px">
                <option value="">‚Äî No agent yet ‚Äî</option>
                ${agentOpts}
              </select>
            </div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button onclick="adminVerifyToken('${p.move_id}','approve')" style="flex:1;padding:10px;background:#dcfce7;border:1.5px solid #86efac;border-radius:8px;color:#15803d;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">‚úì Verify & Activate Move</button>
              <button onclick="adminVerifyToken('${p.move_id}','reject')" style="padding:10px 14px;background:#fef2f2;border:1.5px solid #fecaca;border-radius:8px;color:#dc2626;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">‚úó</button>
            </div>` : `
            <div style="display:flex;gap:8px;margin-top:10px">
              <button onclick="adminVerifyBalance('${p.move_id}','approve')" style="flex:1;padding:10px;background:#dcfce7;border:1.5px solid #86efac;border-radius:8px;color:#15803d;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">‚úì Verify Balance</button>
              <button onclick="adminVerifyBalance('${p.move_id}','reject')" style="padding:10px 14px;background:#fef2f2;border:1.5px solid #fecaca;border-radius:8px;color:#dc2626;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer">‚úó</button>
            </div>`}
          </div>`;
        }).join('')}
      </div>` : ''}
      <div style="font-size:11px;font-weight:700;color:var(--sub);letter-spacing:0.8px;margin-bottom:12px">ALL PAYMENTS</div>
      <div class="card" style="padding:0">
        ${all.length ? all.map(p => `
        <div style="padding:12px 14px;border-bottom:1px solid var(--border)">
          <div style="display:flex;justify-content:space-between">
            <div style="flex:1;min-width:0">
              <div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.move_title}</div>
              <div style="font-size:11px;color:var(--sub)">${p.customer_name} ¬∑ ${p.payment_mode.replace('_',' ')}</div>
            </div>
            <div style="text-align:right;flex-shrink:0;margin-left:10px">
              <div style="font-weight:700;color:var(--accent)">‚Çπ${parseFloat(p.amount).toLocaleString('en-IN')}</div>
              <div style="font-size:11px;font-weight:600;color:${statusColor[p.status]||'var(--sub)'}">${p.status.replace('_',' ')}</div>
            </div>
          </div>
        </div>`).join('') : '<div style="padding:20px;text-align:center;color:var(--dim)">No payments yet</div>'}
      </div>`;
  } catch(e) { c.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`; }
}

async function renderAdminUsers() {
  const c = document.getElementById('adminContent');
  try {
    const users = await api('GET','/api/admin/users');
    adminData.users = users;
    const roleColor = { admin:'#a78bfa', agent:'var(--accent)', customer:'var(--accent2)' };
    const grouped = {
      admin: users.filter(u=>u.role==='admin'),
      agent: users.filter(u=>u.role==='agent'),
      customer: users.filter(u=>u.role==='customer'),
    };
    c.innerHTML = ['admin','agent','customer'].map((role,i) => `
      ${i>0?'<div style="height:8px"></div>':''}
      <div style="font-size:11px;font-weight:700;color:var(--sub);letter-spacing:0.8px;margin-bottom:12px">${role.toUpperCase()}S (${grouped[role].length})</div>
      <div class="card" style="padding:0">
        ${grouped[role].length ? grouped[role].map(u => `
        <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid var(--border)">
          <div style="width:36px;height:36px;border-radius:50%;background:${roleColor[u.role]};display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0">
            ${u.name.split(' ').map(w=>w[0]).join('').substring(0,2)}
          </div>
          <div style="flex:1;min-width:0">
            <div style="font-weight:600">${u.name}</div>
            <div style="font-size:12px;color:var(--sub);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${u.email}</div>
            ${u.total_moves>0?`<div style="font-size:11px;color:var(--dim)">${u.total_moves} moves</div>`:''}
          </div>
          <select onchange="doChangeUserRole('${u.id}',this.value)"
            style="background:var(--card2);border:1px solid var(--border);color:${roleColor[u.role]};padding:6px 8px;border-radius:8px;font-family:inherit;font-size:11px;font-weight:700;outline:none;cursor:pointer;flex-shrink:0">
            <option value="customer" ${u.role==='customer'?'selected':''}>Customer</option>
            <option value="agent" ${u.role==='agent'?'selected':''}>Agent</option>
            <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
          </select>
        </div>`).join('') : '<div style="padding:16px;color:var(--dim);font-size:13px;text-align:center">None</div>'}
      </div>`).join('');
  } catch(e) { c.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`; }
}

async function adminVerifyPayment(paymentId, action) {
  try {
    const data = await api('POST', `/api/admin/payments/${paymentId}/verify`, { action });
    toast(data.message, action==='approve' ? 'success' : 'error');
    switchAdminTab(adminTab);
  } catch(e) { toast(e.message, 'error'); }
}

async function doChangeUserRole(userId, newRole) {
  try {
    await api('PATCH', `/api/admin/users/${userId}/role`, { role: newRole });
    toast(`Role updated to ${newRole} ‚úì`, 'success');
  } catch(e) { toast(e.message, 'error'); }
}

const FLAG_META = {
  intra_city_only:  { label: 'Intra-City Only',      desc: 'Restrict move creation to same-city routes only', icon: 'üèôÔ∏è' },
  cost_estimator:   { label: 'Cost Estimator',        desc: 'Show BHK-based price estimate during move creation', icon: 'üí∞' },
  client_inventory: { label: 'Client Inventory',      desc: 'Allow clients to declare items before move day', icon: 'üìã' },
  damage_disputes:  { label: 'Damage Disputes',       desc: 'Let clients raise a dispute on condition changes', icon: '‚ö†Ô∏è' },
  post_move_rating: { label: 'Post-Move Rating',      desc: 'Prompt clients to rate their move after completion', icon: '‚≠ê' },
  document_vault:   { label: 'Document Vault',        desc: 'Allow document uploads (NOC, permits, etc.)', icon: 'üìÅ' },
  notifications:    { label: 'In-App Notifications',  desc: 'Enable real-time activity notifications for clients', icon: 'üîî' },
};

async function renderAdminFlags() {
  const c = document.getElementById('adminContent');
  try {
    const flags = await api('GET', '/api/feature-flags');
    c.innerHTML = `
      <div style="margin-bottom:16px">
        <div style="font-size:13px;color:var(--sub)">Toggle features on/off without redeploying. Changes take effect immediately.</div>
      </div>
      <div class="card" style="padding:0">
        ${flags.map((f, i) => {
          const meta = FLAG_META[f.key] || { label: f.key, desc: '', icon: 'üö©' };
          return `
          <div style="display:flex;align-items:center;gap:14px;padding:16px 16px;${i < flags.length-1 ? 'border-bottom:1px solid var(--border)' : ''}">
            <div style="font-size:24px;flex-shrink:0">${meta.icon}</div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:700;font-size:14px">${meta.label}</div>
              <div style="font-size:12px;color:var(--sub);margin-top:2px">${meta.desc}</div>
            </div>
            <label style="position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;cursor:pointer">
              <input type="checkbox" ${f.enabled ? 'checked' : ''} onchange="toggleFlag('${f.key}',this.checked)"
                style="opacity:0;width:0;height:0;position:absolute">
              <span id="toggle-${f.key}" style="position:absolute;inset:0;border-radius:24px;transition:0.2s;background:${f.enabled ? '#2563eb' : '#e2e8f0'}">
                <span style="position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;left:${f.enabled ? '23px' : '3px'};transition:0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.2)"></span>
              </span>
            </label>
          </div>`;
        }).join('')}
      </div>`;
  } catch(e) { c.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">${e.message}</div></div>`; }
}

async function toggleFlag(key, enabled) {
  try {
    await api('PUT', `/api/feature-flags/${key}`, { enabled });
    const span = document.getElementById('toggle-' + key);
    if (span) {
      span.style.background = enabled ? '#2563eb' : '#e2e8f0';
      const knob = span.querySelector('span');
      if (knob) knob.style.left = enabled ? '23px' : '3px';
    }
    toast(`${FLAG_META[key]?.label || key} ${enabled ? 'enabled' : 'disabled'}`, enabled ? 'success' : 'error');
  } catch(e) { toast(e.message, 'error'); }
}

</script>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CLIENT FLOW MODALS & PANELS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Notifications Panel -->
<div class="modal-overlay" id="notifPanel" onclick="closeModal('notifPanel')">
  <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:80vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div class="modal-title" style="margin:0">Notifications</div>
      <button onclick="markAllNotifsRead()" style="font-size:12px;color:var(--accent);background:none;border:none;cursor:pointer;font-family:inherit">Mark all read</button>
    </div>
    <div id="notifList"><div style="text-align:center;padding:32px;color:var(--sub)">Loading...</div></div>
  </div>
</div>

<!-- Rate Move Modal -->
<div class="modal-overlay" id="rateMoveModal" onclick="closeModal('rateMoveModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">üåü Rate Your Move</div>
    <div style="font-size:13px;color:var(--sub);margin-bottom:20px">How was your experience with MoveAssist?</div>
    <div id="starRating" style="display:flex;gap:8px;justify-content:center;margin-bottom:20px;font-size:36px">
      ${[1,2,3,4,5].map(n=>`<span onclick="setRating(${n})" id="star-${n}" style="cursor:pointer;opacity:0.3;transition:all 0.15s">‚òÖ</span>`).join('')}
    </div>
    <div class="field">
      <label>Your Review (optional)</label>
      <textarea id="ratingReview" placeholder="What went well? Any suggestions?" style="height:80px"></textarea>
    </div>
    <button class="btn btn-primary" onclick="submitRating()" id="submitRatingBtn">Submit Rating</button>
  </div>
</div>

<!-- Raise Dispute Modal -->
<div class="modal-overlay" id="disputeModal" onclick="closeModal('disputeModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">‚ö†Ô∏è Raise Damage Dispute</div>
    <div style="font-size:13px;color:var(--sub);margin-bottom:16px">Describe the damage or issue you noticed.</div>
    <div class="field">
      <label>Affected Item</label>
      <select id="disputeFurnSelect"><option value="">Select furniture item (optional)</option></select>
    </div>
    <div class="field">
      <label>Description *</label>
      <textarea id="disputeDesc" placeholder="Describe the damage in detail..." style="height:90px"></textarea>
    </div>
    <div class="field">
      <label>üì∑ Your Photo (optional)</label>
      <div id="disputePhotoPreview" style="display:none;position:relative;margin-bottom:10px">
        <img id="disputePhotoImg" style="width:100%;max-height:180px;object-fit:cover;border-radius:10px"/>
        <button onclick="disputePhotoDataUrl=null;document.getElementById('disputePhotoPreview').style.display='none'" style="position:absolute;top:8px;right:8px;background:#1e293b;color:#fff;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:16px">√ó</button>
      </div>
      <button onclick="document.getElementById('disputePhotoInput').click()" style="width:100%;padding:10px;background:#f8fafc;border:1.5px dashed #cbd5e1;border-radius:10px;color:var(--sub);font-size:13px;cursor:pointer">üì∑ Attach Photo</button>
      <input type="file" id="disputePhotoInput" accept="image/*" style="display:none" onchange="handleDisputePhoto(this)"/>
    </div>
    <button class="btn btn-primary" onclick="submitDispute()" id="submitDisputeBtn" style="background:#dc2626;border-color:#dc2626">Submit Dispute</button>
  </div>
</div>

<!-- Document Vault Modal -->
<div class="modal-overlay" id="docVaultModal" onclick="closeModal('docVaultModal')">
  <div class="modal-sheet" onclick="event.stopPropagation()" style="max-height:80vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div class="modal-title">üìÅ Document Vault</div>
    <div style="font-size:13px;color:var(--sub);margin-bottom:16px">Upload society NOC, parking permits, or other move-related documents.</div>
    <div id="docVaultList" style="margin-bottom:16px"></div>
    <div style="background:#f8fafc;border:1.5px dashed #cbd5e1;border-radius:12px;padding:16px;margin-bottom:12px">
      <div class="field"><label>Document Name</label><input type="text" id="docName" placeholder="e.g. Society NOC"/></div>
      <div class="field">
        <label>Type</label>
        <select id="docType">
          <option value="noc">Society NOC</option>
          <option value="parking">Parking Permit</option>
          <option value="entry">Building Entry Form</option>
          <option value="insurance">Insurance</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="field">
        <label>üìÑ File</label>
        <div id="docFilePreview" style="display:none;background:#eff6ff;border-radius:8px;padding:10px;margin-bottom:8px;font-size:13px;color:var(--accent)" id="docFilePreview"></div>
        <button onclick="document.getElementById('docFileInput').click()" style="width:100%;padding:10px;background:#f8fafc;border:1.5px dashed #cbd5e1;border-radius:10px;color:var(--sub);font-size:13px;cursor:pointer">üìé Choose File</button>
        <input type="file" id="docFileInput" accept="image/*,application/pdf" style="display:none" onchange="handleDocFile(this)"/>
      </div>
      <button class="btn btn-primary" onclick="uploadDocument()" id="uploadDocBtn">Upload Document</button>
    </div>
  </div>
</div>

<style>
.address-suggestions { position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.12);z-index:1000;max-height:200px;overflow-y:auto;display:none }
.address-suggestion-item { padding:10px 14px;cursor:pointer;font-size:13px;border-bottom:1px solid #f1f5f9 }
.address-suggestion-item:hover { background:#eff6ff }
.address-suggestion-item:last-child { border-bottom:none }
.chip-btn.selected { background:var(--accent)!important;color:#fff!important;border-color:var(--accent)!important }
.timeline-item { display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #f1f5f9 }
.timeline-item:last-child { border-bottom:none }
.timeline-dot { width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px }
.notif-item { padding:14px;border-bottom:1px solid #f1f5f9;cursor:pointer }
.notif-item:last-child { border-bottom:none }
.notif-item.unread { background:#eff6ff }
.notif-item:hover { background:#f8fafc }
.dispute-card { background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;margin-bottom:8px }
.doc-card { background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:10px }
</style>

</body>
</html>
